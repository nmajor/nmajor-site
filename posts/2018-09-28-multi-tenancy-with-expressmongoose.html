<!DOCTYPE html><html lang="en" class="h-full antialiased"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="image" imageSrcSet="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=16&amp;q=75 16w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=32&amp;q=75 32w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=48&amp;q=75 48w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=64&amp;q=75 64w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=96&amp;q=75 96w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=128&amp;q=75 128w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=256&amp;q=75 256w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=384&amp;q=75 384w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=640&amp;q=75 640w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=750&amp;q=75 750w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=828&amp;q=75 828w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=1080&amp;q=75 1080w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=1200&amp;q=75 1200w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=1920&amp;q=75 1920w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=2048&amp;q=75 2048w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=3840&amp;q=75 3840w" imageSizes="2.25rem" fetchPriority="high"/><link rel="stylesheet" href="/_next/static/css/9d8f288a99c54fb3.css" crossorigin="" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-113544170b8b14d7.js" crossorigin=""/><script src="/_next/static/chunks/de8a8aed-ff24f23ca546a20c.js" async="" crossorigin=""></script><script src="/_next/static/chunks/362-edde6a9467fb7f3f.js" async="" crossorigin=""></script><script src="/_next/static/chunks/main-app-dca2b37e6b098eb8.js" async="" crossorigin=""></script><script src="/_next/static/chunks/736-93d26bf9f492bada.js" async=""></script><script src="/_next/static/chunks/545-972397648c423446.js" async=""></script><script src="/_next/static/chunks/871-e93f475163439fcd.js" async=""></script><script src="/_next/static/chunks/app/layout-58152a9375fe786b.js" async=""></script><script src="/_next/static/chunks/app/posts/page-6d06c0c42f2ef9eb.js" async=""></script><title>Multi Tenancy with Express/Mongoose - Spencer Sharp</title><meta name="description" content="I’m Spencer, a software designer and entrepreneur based in New York City. I’m the founder and CEO of Planetaria, where we develop technologies that empower regular people to explore space on their own terms."/><link rel="alternate" type="application/rss+xml" href="undefined/feed.xml"/><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" crossorigin="" noModule=""></script></head><body class="flex h-full"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><div class="flex w-full"><div class="relative flex w-full flex-col"><header class="pointer-events-none relative z-50 flex flex-none flex-col" style="height:var(--header-height);margin-bottom:var(--header-mb)"><div class="top-0 z-10 h-16 pt-6" style="position:var(--header-position)"><div class="sm:px-8 top-[var(--header-top,theme(spacing.6))] w-full" style="position:var(--header-inner-position)"><div class="mx-auto w-full max-w-7xl lg:px-8"><div class="relative px-4 sm:px-8 lg:px-12"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class="relative flex gap-4"><div class="flex flex-1"><div class="h-10 w-10 rounded-full bg-white/90 p-0.5 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur dark:bg-zinc-800/90 dark:ring-white/10"><a aria-label="Home" class="pointer-events-auto" href="/"><img alt="" fetchPriority="high" width="1000" height="1000" decoding="async" data-nimg="1" class="rounded-full bg-zinc-100 object-cover dark:bg-zinc-800 h-9 w-9" style="color:transparent" sizes="2.25rem" srcSet="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=16&amp;q=75 16w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=32&amp;q=75 32w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=48&amp;q=75 48w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=64&amp;q=75 64w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=96&amp;q=75 96w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=128&amp;q=75 128w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=256&amp;q=75 256w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=384&amp;q=75 384w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=640&amp;q=75 640w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=750&amp;q=75 750w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=828&amp;q=75 828w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=1080&amp;q=75 1080w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=1200&amp;q=75 1200w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=1920&amp;q=75 1920w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=2048&amp;q=75 2048w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=3840&amp;q=75 3840w" src="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=3840&amp;q=75"/></a></div></div><div class="flex flex-1 justify-end md:justify-center"><nav class="pointer-events-auto hidden md:block"><ul class="flex rounded-full bg-white/90 px-3 text-sm font-medium text-zinc-800 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur dark:bg-zinc-800/90 dark:text-zinc-200 dark:ring-white/10"><li><a class="relative block px-3 py-2 transition hover:text-teal-500 dark:hover:text-teal-400" href="/about">About</a></li><li><a class="relative block px-3 py-2 transition hover:text-teal-500 dark:hover:text-teal-400" href="/posts">Blog</a></li><li><a class="relative block px-3 py-2 transition hover:text-teal-500 dark:hover:text-teal-400" href="/projects">Projects</a></li></ul></nav></div><div class="flex justify-end md:flex-1"><div class="pointer-events-auto"><button class="inline-flex items-center justify-center text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground rounded-md h-8 w-8 px-0" type="button" id="radix-:R75la:" aria-haspopup="menu" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0"><circle cx="12" cy="12" r="4"></circle><path d="M12 3v1"></path><path d="M12 20v1"></path><path d="M3 12h1"></path><path d="M20 12h1"></path><path d="m18.364 5.636-.707.707"></path><path d="m6.343 17.657-.707.707"></path><path d="m5.636 5.636.707.707"></path><path d="m17.657 17.657.707.707"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg><span class="sr-only">Toggle theme</span></button></div></div></div></div></div></div></div></div></header><main class="flex-auto"><div class="sm:px-8 post mt-16 lg:mt-32"><div class="mx-auto w-full max-w-7xl lg:px-8"><div class="relative px-4 sm:px-8 lg:px-12"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class="xl:relative"><div class="mx-auto max-w-2xl"><article><header class="flex flex-col"><h1 class="text-4xl font-bold font-bold tracking-tight sm:text-5xl">Multi Tenancy with Express/Mongoose</h1><div class="flex gap-3 pt-1"><time dateTime="2018-10-03" class="text-muted-foreground order-first flex items-center pr-2 text-base"><span class="h-4 w-0.5 rounded-full bg-zinc-200 dark:bg-zinc-500"></span><span class="ml-3">October 3, 2018</span></time><span class="text-muted-foreground">-</span><span class="text-muted-foreground/80">mongoose</span><span class="text-muted-foreground/80">express</span><span class="text-muted-foreground/80">node</span><span class="text-muted-foreground/80">javascript</span></div><div class="text-accent-foreground pt-3 text-sm italic">~<!-- -->10 min read</div></header><div class="mt-8 prose dark:prose-invert" data-mdx-content="true"><div><p>Adding this kind of layer to apps is really useful and powerful and can really level up some apps.</p>
<p>The most important thing with multi tenant apps is that the data isolation must be perfect. If a user ever sees data not related to their tenant, it can result it a huge loss of customer trust especially these days when user data is such a hot issue.</p>
<p>We should NOT rely on developers writing queries and logic to keep this data isolation, so the best thing to do is to tackle this at a high level with powerful patterns.</p>
<p>Here's a possible implementation:</p>
<p>The plan:</p>
<ul>
<li><strong>Continuation-Local Storage</strong> - Use <a href="">this library</a> to easily give every function access to the current tenant at all times.</li>
<li><strong>Express Middleware</strong> - Add express middleware that will tell set the current tenent for every request.</li>
<li><strong>Mongoose Discriminator</strong> - For every tenant create an on-the-fly discriminator model, so all actions performed by the model are in the context of the current tenant.</li>
<li><strong>Model Wrapper</strong> - Add a wrapper around Mongoose models so that every time that model is used it actually gets a different version of the model specific to the current tenant.</li>
</ul>
<p>I'm assuming you have a basic understanding of express and mongoose.</p>
<h3 id="continuation-local-storage"><a aria-hidden="true" tabindex="-1" href="#continuation-local-storage"><a href="#continuation-local-storage" style="margin-right: 10px">#</a></a>Continuation-Local Storage</h3>
<p>I recently found this great library called <a href="https://github.com/othiym23/node-continuation-local-storage" title="https://github.com/othiym23/node-continuation-local-storage">node-continuation-local-storage</a>. Basically you can think of most things in javascript as a chain of functions calling functions. What this library does is lets you define variables at the beginning of the function chain, and then every function further down the chain has access to those variables.</p>
<p>The first thing we'll do is set this library up with express. We do that by first binding the context using an express middleware function, this gives continuous-local-storage a namespace and context to store our variables.</p>
<p>Lets create a file called <code>lib/storage.js</code> and create an express middleware function to bind the storage context as well as a few exportable getter and setter functions for our <code>tenantId</code> variable.</p>
<pre><code>// lib/storage.js
import { createNamespace } from 'continuation-local-storage';

const namespaceName = 'request';
const ns = createNamespace(namespaceName);

export function bindCurrentNamespace(req, res, next) {
  ns.bindEmitter(req);
  ns.bindEmitter(res);

  ns.run(() => {
    next();
  });
}

export function setCurrentTenantId(tenantId) {
  return ns.set('tenantId', tenantId);
}

export function getCurrentTenantId() {
  return ns.get('tenantId');
}
</code></pre>
<p>Now inside your express bootstrap file, usually called <code>app.js</code> we add the <code>bindCurrentNamespace</code> middleware.</p>
<pre><code>// app.js

import { bindCurrentNamespace } from 'lib/storage';

app.use(bindCurrentNamespace);
</code></pre>
<p>This creates a context that every express request can use.</p>
<p>Next we'll add another middleware function that will use our <code>setCurrentTenantId</code> function to set that data for every other function in the chain.</p>
<h3 id="express-middleware"><a aria-hidden="true" tabindex="-1" href="#express-middleware"><a href="#express-middleware" style="margin-right: 10px">#</a></a>Express Middleware</h3>
<p>No here is where you'll probably want to tie into any existing authentication system you have. Basically we need to someone figure out which user each request comes from.</p>
<p>Some of the most common approaches here is to connect it with a session or use a bearer token with each request. But this is one area where many people will have different implementations.</p>
<p>We nee to figure out which user the request is connected to, and once we have the user, you should be able to tell which tenant the user belongs to:</p>
<pre><code>// app.js

import { bindCurrentNamespace, setCurrentTenantId } from 'lib/storage';

app.use(bindCurrentNamespace);
app.use((req, res, next) => {
  // Get current user from session or token
  const user = req.user
  
  // Get current tenant from user here
  // Make sure its a string
  const tenantId = user.organization._id.toString()
  
  setCurrentTenantId('tenantId', tenantId);
  next();
});
</code></pre>
<p>There you have it. Now every function for every request will have access to the current tenant of the user making the request. We'll next use this behavior to bind our models to the tenant context.</p>
<h3 id="mongoose-discriminator"><a aria-hidden="true" tabindex="-1" href="#mongoose-discriminator"><a href="#mongoose-discriminator" style="margin-right: 10px">#</a></a>Mongoose Discriminator</h3>
<p>So here is where the magic happens. Lets create a new file called <code>lib/multiTenant.js</code> this file is going to export some higher order functions that will wrap every model with a discriminator based on the tenant id.</p>
<pre><code>// lib/multiTenant.js

import mongoose, { Schema } from 'mongoose';
import { getCurrentTenantId } from './storage';

export function tenantModel(name, schema, options) {
  return (props = {}) => {
    schema.add({ tenantId: String });
    const Model = mongoose.model(name, schema, options);

    const { skipTenant } = props;
    if (skipTenant) return Model;

    Model.schema.set('discriminatorKey', 'tenantId');

    const tenantId = getCurrentTenantId();
    const discriminatorName = `${Model.modelName}-${tenantId}`;
    const existingDiscriminator = (Model.discriminators || {})[discriminatorName];
    return existingDiscriminator || Model.discriminator(discriminatorName, new Schema({}));
  };
}

export function tenantlessModel(name, schema, options) {
  return () => mongoose.model(name, schema, options);
}
</code></pre>
<p>You'll notice we have two exported higher order functions. If you're unfamiliar with <a href="https://eloquentjavascript.net/05_higher_order.html" title="https://eloquentjavascript.net/05_higher_order.html">higher order functions</a>, they are basically just functions that return other functions. Its a very powerful and often used pattern in javascript.</p>
<p>The function <code>tenantlessModel</code> is basically just a passthrough function. We can use this function on any model that should not be tenant-isolated. One of the main examples of this is our tenant model itself which we have been calling <code>organization</code>. So our <code>organization</code> model will use this function.</p>
<p>The other function is where all the magic happens. <code>tenantModel</code> exports another function. And that function returns a modified mongoose model or discriminator.</p>
<p>Lets break down the code section by section:</p>
<pre><code>schema.add({ [tenantKey]: String });
const Model = mongoose.model(name, schema, options);
</code></pre>
<p>In this line we're just adding a new attribute to the model schema to hold our <code>tenantId</code>.</p>
<pre><code>const { skipTenant } = props;
if (skipTenant) return Model;
</code></pre>
<p>This is just a useful feature. This allows us to easily bypass our tenant isolation whenever we want. I've found this particularly useful in testing. But also for things like looking up the user during authentication when its important to be able to search for all users in the database.</p>
<p>But this makes it so the norm is the tenant isolation, and we have to explicitly override it if we want access to all the models in the database.</p>
<pre><code>Model.schema.set('discriminatorKey', 'tenantId');
</code></pre>
<p>This is pretty basic, we're just telling the model to use the field <code>'tenantId'</code> as the discriminator key.</p>
<pre><code>const tenantId = getCurrentTenantId();
const discriminatorName = `${Model.modelName}-${tenantId}`;
const existingDiscriminator = (Model.discriminators || {})[discriminatorName];
return existingDiscriminator || Model.discriminator(discriminatorName, new Schema({}));
</code></pre>
<p>Here is where we actually build a new discriminator based on the current tenant.</p>
<p>Remember discriminators are basically just augmented mongoose models. The common use case is when you want to simulate model inheritance and basically have one model be the same as another but with extra behavior. The discriminator name is the name of the new augmented model. We're sort of hacking this feature for its built in data isolation.</p>
<p>We're basically telling mongoose that there will be a different version of each model for each tenant. So if a user belongs to the tenant with the id of <code>123456</code> and we want to find all the documents in a model called <code>page</code> then we're not looking up all the <code>page</code>s we're looking up all the <code>page-123456</code>s.</p>
<p>That is why we have to set the model name to <code>${Model.modelName}-${tenantId}</code> because we cant have multiple models with the same name.</p>
<p>Then its important to check if the model name already exists so we don't end up creating multiple versions of the same discriminator. Also mongoose will yell at you if you try. So that is what this line is about:</p>
<pre><code>const existingDiscriminator = (Model.discriminators || {})[discriminatorName];
</code></pre>
<h3 id="model-wrapper"><a aria-hidden="true" tabindex="-1" href="#model-wrapper"><a href="#model-wrapper" style="margin-right: 10px">#</a></a>Model Wrapper</h3>
<p>So now that we have these higher order functions we have to user them to wrap our existing mongoose models. This is actually pretty easy. Here are a couple examples:</p>
<pre><code>// models/page.js
import { tenantModel } from '../lib/multiTenant';

const PageSchema = new Schema({
  title: String,
  body: String,
});

export default tenantModel('page', PageSchema);
</code></pre>
<p>And:</p>
<pre><code>// models/user.js
import { tenantModel } from '../lib/multiTenant';

const UserSchema = new Schema({
  name: String,
  email: String,
});

export default tenantModel('user', UserSchema);
</code></pre>
<p>You'll notice that its exactly the same as making and exporting a regular mongoose model except instead of exporting <code>mongoose.model</code> we are exporting our own <code>tenantModel</code> function.</p>
<p>Then for models that you want to live outside the tenant isolation you can do this:</p>
<pre><code>// models/organization.js

import { tenantlessModel } from '../lib/multiTenant';

const OrganizationSchema = new Schema({
  name: String,
});

export default tenantlessModel('organization', OrganizationSchema);
</code></pre>
<p>Since the <code>tenantlessModel</code> is just a passthrough, its not totally necessary. But I chose to do it because as you will see below, our usage of higher order functions changes how we actually use our models in the rest of our code. So the <code>tenantlessModel</code> function makes the usage standardized for all our models regardless of if they are isolated based on the current tenant.</p>
<h3 id="usage"><a aria-hidden="true" tabindex="-1" href="#usage"><a href="#usage" style="margin-right: 10px">#</a></a>Usage</h3>
<p>Now this does change how we actually use our models in the rest of our code. Because our default export in our models are higher order functions, we have to execute the returned function before we use each model.</p>
<p>For example we can NO LONGER DO THIS:</p>
<pre><code>Page.find({})
</code></pre>
<p>Instead we have to do this:</p>
<pre><code>Page().find({})
</code></pre>
<p>But this actually turns out to be pretty useful. Remember that <code>skipTenant</code> thing before? We can actually pass options into our model function like <code>skipTenant</code> to customize our access to the model even further.</p>
<p>For example to search EVERY user in our database, not just the ones associated with our current tenant we can do this:</p>
<pre><code>User({ skipTenant: true }).find({ _id: '123456' })
</code></pre>
<h3 id="benefits"><a aria-hidden="true" tabindex="-1" href="#benefits"><a href="#benefits" style="margin-right: 10px">#</a></a>Benefits</h3>
<p>You'll notice that this implementation really doesn't require a lot of code.</p>
<p>It also gives us a lot of useful abstraction layers to add extra behavior to our models.</p>
<p>But, whats really great about this approach is that because we are always dealing with tenant isolated versions of every model, then any model that is created by a logged in user is <strong>automatically</strong> assigned to the correct tenant.</p>
<p>And all queries and lookups are <strong>automatically</strong> isolated to the tenant.</p>
<p>And it is basically nearly impossible for a user to view, list, update, create, or delete any model outside their own tenant because any mongoose function used to perform those actions is isolated to the users tenant from the get go.</p>
<p>We don't have to rely on developers coding correct logic. And we can easily add other authentication logic on top of it and be confident our tenant isolation is secure.</p>
<h3 id="extra-customization"><a aria-hidden="true" tabindex="-1" href="#extra-customization"><a href="#extra-customization" style="margin-right: 10px">#</a></a>Extra Customization</h3>
<p>Because our higher order functions have access to the schema of each model, we can do lots of things to our models. For example we can add new middleware to any model that has a tenant. Here's just one simple example of making sure every <code>tenantModel</code> has a tenant using the before save mongoose middleware:</p>
<pre><code>export function tenantModel(name, schema, options) {
  return (props = {}) => {
    schema.add({ tenantId: String });

    schema.pre('save', function (next) {
      if (!this.tenantId) {
        const defaultTenantId = // find tenant
        this.tenantId = defaultTenantId;
      }
    });
  
    const Model = mongoose.model(name, schema, options);

    // ...
  };
}
</code></pre>
<p>You can also insert some authorization logic in here. For example you could set the current user using Continuation-Local Storage and then if the user is an admin, return the unmodified model, like this:</p>
<pre><code>import { getCurrentTenantId, getCurrentUser } from './storage';

export function tenantModel(name, schema, options) {
  return (props = {}) => {
    schema.add({ tenantId: String });
    const Model = mongoose.model(name, schema, options);

    if (getCurrentUser().isAdmin()) return Model;

	// ...
  };
}
</code></pre>
<h3 id="conclusion"><a aria-hidden="true" tabindex="-1" href="#conclusion"><a href="#conclusion" style="margin-right: 10px">#</a></a>Conclusion</h3>
<p>I hope this at least gives you some ideas of how to add a solid multi-tenant layer in your express/mongoose app.</p>
<p>As always, if you notice any problems in my code or flaws in my approach, please let me know. I'm always looking to learn and improve.</p>
<p>Thanks for reading!</p>
<p>Thanks to these libraries for inspiration:</p>
<ul>
<li><a href="https://www.npmjs.com/package/mongoose-multitenant" title="https://www.npmjs.com/package/mongoose-multitenant">https://www.npmjs.com/package/mongoose-multitenant</a></li>
<li><a href="https://www.npmjs.com/package/mongoose-multitenant" title="https://www.npmjs.com/package/mongoose-multitenant">https://www.npmjs.com/package/mongoose-multitenancy</a></li>
</ul></div></div></article></div></div></div></div></div></div></main><footer class="mt-32 flex-none"><div class="sm:px-8"><div class="mx-auto w-full max-w-7xl lg:px-8"><div class="pb-16 pt-10"><div class="relative px-4 sm:px-8 lg:px-12"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class="flex flex-col items-center justify-between gap-6 sm:flex-row"><div class="flex flex-wrap justify-center gap-x-6 gap-y-1 text-sm font-medium text-zinc-800 dark:text-zinc-200"><a class="transition hover:text-teal-500 dark:hover:text-teal-400" href="/about">About</a><a class="transition hover:text-teal-500 dark:hover:text-teal-400" href="/projects">Projects</a><a class="transition hover:text-teal-500 dark:hover:text-teal-400" href="/speaking">Speaking</a><a class="transition hover:text-teal-500 dark:hover:text-teal-400" href="/uses">Uses</a></div><p class="text-sm text-zinc-400 dark:text-zinc-500">© <!-- -->2023<!-- --> Spencer Sharp. All rights reserved.</p></div></div></div></div></div></div></footer></div></div><script src="/_next/static/chunks/webpack-113544170b8b14d7.js" crossorigin="" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/9d8f288a99c54fb3.css\",\"style\",{\"crossOrigin\":\"\"}]\n0:\"$L2\"\n"])</script><script>self.__next_f.push([1,"3:I[7483,[],\"\"]\n5:I[655,[],\"\"]\n6:I[2286,[\"736\",\"static/chunks/736-93d26bf9f492bada.js\",\"545\",\"static/chunks/545-972397648c423446.js\",\"871\",\"static/chunks/871-e93f475163439fcd.js\",\"185\",\"static/chunks/app/layout-58152a9375fe786b.js\"],\"ThemeProvider\"]\n7:I[7019,[\"736\",\"static/chunks/736-93d26bf9f492bada.js\",\"545\",\"static/chunks/545-972397648c423446.js\",\"871\",\"static/chunks/871-e93f475163439fcd.js\",\"185\",\"static/chunks/app/layout-58152a9375fe786b.js\"],\"Header\"]\n8:I[3849,[],\"\"]\n9:I[8656,[],\"\"]\na:I[4736,[\"736\",\"s"])</script><script>self.__next_f.push([1,"tatic/chunks/736-93d26bf9f492bada.js\",\"991\",\"static/chunks/app/posts/page-6d06c0c42f2ef9eb.js\"],\"\"]\n"])</script><script>self.__next_f.push([1,"2:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/9d8f288a99c54fb3.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}]],[\"$\",\"$L3\",null,{\"buildId\":\"ukvsT-xGIrbijjiNPJuDN\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/posts/2018-09-28-multi-tenancy-with-expressmongoose\",\"initialTree\":[\"\",{\"children\":[\"posts\",{\"children\":[[\"slug\",\"2018-09-28-multi-tenancy-with-expressmongoose\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"2018-09-28-multi-tenancy-with-expressmongoose\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[false,\"$L4\"],\"globalErrorComponent\":\"$5\",\"children\":[null,[\"$\",\"html\",null,{\"lang\":\"en\",\"className\":\"h-full antialiased\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"body\",null,{\"className\":\"flex h-full\",\"children\":[\"$\",\"$L6\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"disableTransitionOnChange\":true,\"children\":[\"$\",\"div\",null,{\"className\":\"flex w-full\",\"children\":[\"$\",\"div\",null,{\"className\":\"relative flex w-full flex-col\",\"children\":[[\"$\",\"$L7\",null,{}],[\"$\",\"main\",null,{\"className\":\"flex-auto\",\"children\":[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[\"$\",\"div\",null,{\"className\":\"sm:px-8 flex h-full items-center pt-16 sm:pt-32\",\"children\":[\"$\",\"div\",null,{\"className\":\"mx-auto w-full max-w-7xl lg:px-8\",\"children\":[\"$\",\"div\",null,{\"className\":\"relative px-4 sm:px-8 lg:px-12\",\"children\":[\"$\",\"div\",null,{\"className\":\"mx-auto max-w-2xl lg:max-w-5xl\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex flex-col items-center\",\"children\":[[\"$\",\"p\",null,{\"className\":\"text-base font-semibold text-zinc-400 dark:text-zinc-500\",\"children\":\"404\"}],[\"$\",\"h1\",null,{\"className\":\"mt-4 text-4xl font-bold tracking-tight text-zinc-800 dark:text-zinc-100 sm:text-5xl\",\"children\":\"Page not found\"}],[\"$\",\"p\",null,{\"className\":\"mt-4 text-base text-zinc-600 dark:text-zinc-400\",\"children\":\"Sorry, we couldn’t find the page you’re looking for.\"}],[\"$\",\"$La\",null,{\"href\":\"/\",\"children\":[\"$\",\"button\",null,{\"className\":\"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 mt-4\",\"children\":\"Go back home\"}]}]]}]}]}]}]}],\"notFoundStyles\":[],\"childProp\":{\"current\":[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\",[\"slug\",\"2018-09-28-multi-tenancy-with-expressmongoose\",\"d\"],\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$Lb\",\"$Lc\",null],\"segment\":\"__PAGE__?{\\\"slug\\\":\\\"2018-09-28-multi-tenancy-with-expressmongoose\\\"}\"},\"styles\":null}],\"segment\":[\"slug\",\"2018-09-28-multi-tenancy-with-expressmongoose\",\"d\"]},\"styles\":null}],\"segment\":\"posts\"},\"styles\":null}]}],[\"$\",\"footer\",null,{\"className\":\"mt-32 flex-none\",\"children\":[\"$\",\"div\",null,{\"className\":\"sm:px-8\",\"children\":[\"$\",\"div\",null,{\"className\":\"mx-auto w-full max-w-7xl lg:px-8\",\"children\":[\"$\",\"div\",null,{\"className\":\"pb-16 pt-10\",\"children\":[\"$\",\"div\",null,{\"className\":\"relative px-4 sm:px-8 lg:px-12\",\"children\":[\"$\",\"div\",null,{\"className\":\"mx-auto max-w-2xl lg:max-w-5xl\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex flex-col items-center justify-between gap-6 sm:flex-row\",\"children\":[[\"$\",\"div\",null,{\"className\":\"flex flex-wrap justify-center gap-x-6 gap-y-1 text-sm font-medium text-zinc-800 dark:text-zinc-200\",\"children\":[[\"$\",\"$La\",null,{\"href\":\"/about\",\"className\":\"transition hover:text-teal-500 dark:hover:text-teal-400\",\"children\":\"About\"}],[\"$\",\"$La\",null,{\"href\":\"/projects\",\"className\":\"transition hover:text-teal-500 dark:hover:text-teal-400\",\"children\":\"Projects\"}],[\"$\",\"$La\",null,{\"href\":\"/speaking\",\"className\":\"transition hover:text-teal-500 dark:hover:text-teal-400\",\"children\":\"Speaking\"}],[\"$\",\"$La\",null,{\"href\":\"/uses\",\"className\":\"transition hover:text-teal-500 dark:hover:text-teal-400\",\"children\":\"Uses\"}]]}],[\"$\",\"p\",null,{\"className\":\"text-sm text-zinc-400 dark:text-zinc-500\",\"children\":[\"© \",2023,\" Spencer Sharp. All rights reserved.\"]}]]}]}]}]}]}]}]}]]}]}]}]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"d:T3d14,"])</script><script>self.__next_f.push([1,"\u003cp\u003eAdding this kind of layer to apps is really useful and powerful and can really level up some apps.\u003c/p\u003e\n\u003cp\u003eThe most important thing with multi tenant apps is that the data isolation must be perfect. If a user ever sees data not related to their tenant, it can result it a huge loss of customer trust especially these days when user data is such a hot issue.\u003c/p\u003e\n\u003cp\u003eWe should NOT rely on developers writing queries and logic to keep this data isolation, so the best thing to do is to tackle this at a high level with powerful patterns.\u003c/p\u003e\n\u003cp\u003eHere's a possible implementation:\u003c/p\u003e\n\u003cp\u003eThe plan:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eContinuation-Local Storage\u003c/strong\u003e - Use \u003ca href=\"\"\u003ethis library\u003c/a\u003e to easily give every function access to the current tenant at all times.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eExpress Middleware\u003c/strong\u003e - Add express middleware that will tell set the current tenent for every request.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eMongoose Discriminator\u003c/strong\u003e - For every tenant create an on-the-fly discriminator model, so all actions performed by the model are in the context of the current tenant.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eModel Wrapper\u003c/strong\u003e - Add a wrapper around Mongoose models so that every time that model is used it actually gets a different version of the model specific to the current tenant.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eI'm assuming you have a basic understanding of express and mongoose.\u003c/p\u003e\n\u003ch3 id=\"continuation-local-storage\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#continuation-local-storage\"\u003e\u003ca href=\"#continuation-local-storage\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eContinuation-Local Storage\u003c/h3\u003e\n\u003cp\u003eI recently found this great library called \u003ca href=\"https://github.com/othiym23/node-continuation-local-storage\" title=\"https://github.com/othiym23/node-continuation-local-storage\"\u003enode-continuation-local-storage\u003c/a\u003e. Basically you can think of most things in javascript as a chain of functions calling functions. What this library does is lets you define variables at the beginning of the function chain, and then every function further down the chain has access to those variables.\u003c/p\u003e\n\u003cp\u003eThe first thing we'll do is set this library up with express. We do that by first binding the context using an express middleware function, this gives continuous-local-storage a namespace and context to store our variables.\u003c/p\u003e\n\u003cp\u003eLets create a file called \u003ccode\u003elib/storage.js\u003c/code\u003e and create an express middleware function to bind the storage context as well as a few exportable getter and setter functions for our \u003ccode\u003etenantId\u003c/code\u003e variable.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e// lib/storage.js\nimport { createNamespace } from 'continuation-local-storage';\n\nconst namespaceName = 'request';\nconst ns = createNamespace(namespaceName);\n\nexport function bindCurrentNamespace(req, res, next) {\n  ns.bindEmitter(req);\n  ns.bindEmitter(res);\n\n  ns.run(() =\u003e {\n    next();\n  });\n}\n\nexport function setCurrentTenantId(tenantId) {\n  return ns.set('tenantId', tenantId);\n}\n\nexport function getCurrentTenantId() {\n  return ns.get('tenantId');\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow inside your express bootstrap file, usually called \u003ccode\u003eapp.js\u003c/code\u003e we add the \u003ccode\u003ebindCurrentNamespace\u003c/code\u003e middleware.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e// app.js\n\nimport { bindCurrentNamespace } from 'lib/storage';\n\napp.use(bindCurrentNamespace);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis creates a context that every express request can use.\u003c/p\u003e\n\u003cp\u003eNext we'll add another middleware function that will use our \u003ccode\u003esetCurrentTenantId\u003c/code\u003e function to set that data for every other function in the chain.\u003c/p\u003e\n\u003ch3 id=\"express-middleware\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#express-middleware\"\u003e\u003ca href=\"#express-middleware\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eExpress Middleware\u003c/h3\u003e\n\u003cp\u003eNo here is where you'll probably want to tie into any existing authentication system you have. Basically we need to someone figure out which user each request comes from.\u003c/p\u003e\n\u003cp\u003eSome of the most common approaches here is to connect it with a session or use a bearer token with each request. But this is one area where many people will have different implementations.\u003c/p\u003e\n\u003cp\u003eWe nee to figure out which user the request is connected to, and once we have the user, you should be able to tell which tenant the user belongs to:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e// app.js\n\nimport { bindCurrentNamespace, setCurrentTenantId } from 'lib/storage';\n\napp.use(bindCurrentNamespace);\napp.use((req, res, next) =\u003e {\n  // Get current user from session or token\n  const user = req.user\n  \n  // Get current tenant from user here\n  // Make sure its a string\n  const tenantId = user.organization._id.toString()\n  \n  setCurrentTenantId('tenantId', tenantId);\n  next();\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThere you have it. Now every function for every request will have access to the current tenant of the user making the request. We'll next use this behavior to bind our models to the tenant context.\u003c/p\u003e\n\u003ch3 id=\"mongoose-discriminator\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#mongoose-discriminator\"\u003e\u003ca href=\"#mongoose-discriminator\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eMongoose Discriminator\u003c/h3\u003e\n\u003cp\u003eSo here is where the magic happens. Lets create a new file called \u003ccode\u003elib/multiTenant.js\u003c/code\u003e this file is going to export some higher order functions that will wrap every model with a discriminator based on the tenant id.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e// lib/multiTenant.js\n\nimport mongoose, { Schema } from 'mongoose';\nimport { getCurrentTenantId } from './storage';\n\nexport function tenantModel(name, schema, options) {\n  return (props = {}) =\u003e {\n    schema.add({ tenantId: String });\n    const Model = mongoose.model(name, schema, options);\n\n    const { skipTenant } = props;\n    if (skipTenant) return Model;\n\n    Model.schema.set('discriminatorKey', 'tenantId');\n\n    const tenantId = getCurrentTenantId();\n    const discriminatorName = `${Model.modelName}-${tenantId}`;\n    const existingDiscriminator = (Model.discriminators || {})[discriminatorName];\n    return existingDiscriminator || Model.discriminator(discriminatorName, new Schema({}));\n  };\n}\n\nexport function tenantlessModel(name, schema, options) {\n  return () =\u003e mongoose.model(name, schema, options);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou'll notice we have two exported higher order functions. If you're unfamiliar with \u003ca href=\"https://eloquentjavascript.net/05_higher_order.html\" title=\"https://eloquentjavascript.net/05_higher_order.html\"\u003ehigher order functions\u003c/a\u003e, they are basically just functions that return other functions. Its a very powerful and often used pattern in javascript.\u003c/p\u003e\n\u003cp\u003eThe function \u003ccode\u003etenantlessModel\u003c/code\u003e is basically just a passthrough function. We can use this function on any model that should not be tenant-isolated. One of the main examples of this is our tenant model itself which we have been calling \u003ccode\u003eorganization\u003c/code\u003e. So our \u003ccode\u003eorganization\u003c/code\u003e model will use this function.\u003c/p\u003e\n\u003cp\u003eThe other function is where all the magic happens. \u003ccode\u003etenantModel\u003c/code\u003e exports another function. And that function returns a modified mongoose model or discriminator.\u003c/p\u003e\n\u003cp\u003eLets break down the code section by section:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eschema.add({ [tenantKey]: String });\nconst Model = mongoose.model(name, schema, options);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn this line we're just adding a new attribute to the model schema to hold our \u003ccode\u003etenantId\u003c/code\u003e.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003econst { skipTenant } = props;\nif (skipTenant) return Model;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis is just a useful feature. This allows us to easily bypass our tenant isolation whenever we want. I've found this particularly useful in testing. But also for things like looking up the user during authentication when its important to be able to search for all users in the database.\u003c/p\u003e\n\u003cp\u003eBut this makes it so the norm is the tenant isolation, and we have to explicitly override it if we want access to all the models in the database.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eModel.schema.set('discriminatorKey', 'tenantId');\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis is pretty basic, we're just telling the model to use the field \u003ccode\u003e'tenantId'\u003c/code\u003e as the discriminator key.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003econst tenantId = getCurrentTenantId();\nconst discriminatorName = `${Model.modelName}-${tenantId}`;\nconst existingDiscriminator = (Model.discriminators || {})[discriminatorName];\nreturn existingDiscriminator || Model.discriminator(discriminatorName, new Schema({}));\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHere is where we actually build a new discriminator based on the current tenant.\u003c/p\u003e\n\u003cp\u003eRemember discriminators are basically just augmented mongoose models. The common use case is when you want to simulate model inheritance and basically have one model be the same as another but with extra behavior. The discriminator name is the name of the new augmented model. We're sort of hacking this feature for its built in data isolation.\u003c/p\u003e\n\u003cp\u003eWe're basically telling mongoose that there will be a different version of each model for each tenant. So if a user belongs to the tenant with the id of \u003ccode\u003e123456\u003c/code\u003e and we want to find all the documents in a model called \u003ccode\u003epage\u003c/code\u003e then we're not looking up all the \u003ccode\u003epage\u003c/code\u003es we're looking up all the \u003ccode\u003epage-123456\u003c/code\u003es.\u003c/p\u003e\n\u003cp\u003eThat is why we have to set the model name to \u003ccode\u003e${Model.modelName}-${tenantId}\u003c/code\u003e because we cant have multiple models with the same name.\u003c/p\u003e\n\u003cp\u003eThen its important to check if the model name already exists so we don't end up creating multiple versions of the same discriminator. Also mongoose will yell at you if you try. So that is what this line is about:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003econst existingDiscriminator = (Model.discriminators || {})[discriminatorName];\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"model-wrapper\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#model-wrapper\"\u003e\u003ca href=\"#model-wrapper\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eModel Wrapper\u003c/h3\u003e\n\u003cp\u003eSo now that we have these higher order functions we have to user them to wrap our existing mongoose models. This is actually pretty easy. Here are a couple examples:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e// models/page.js\nimport { tenantModel } from '../lib/multiTenant';\n\nconst PageSchema = new Schema({\n  title: String,\n  body: String,\n});\n\nexport default tenantModel('page', PageSchema);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e// models/user.js\nimport { tenantModel } from '../lib/multiTenant';\n\nconst UserSchema = new Schema({\n  name: String,\n  email: String,\n});\n\nexport default tenantModel('user', UserSchema);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou'll notice that its exactly the same as making and exporting a regular mongoose model except instead of exporting \u003ccode\u003emongoose.model\u003c/code\u003e we are exporting our own \u003ccode\u003etenantModel\u003c/code\u003e function.\u003c/p\u003e\n\u003cp\u003eThen for models that you want to live outside the tenant isolation you can do this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e// models/organization.js\n\nimport { tenantlessModel } from '../lib/multiTenant';\n\nconst OrganizationSchema = new Schema({\n  name: String,\n});\n\nexport default tenantlessModel('organization', OrganizationSchema);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSince the \u003ccode\u003etenantlessModel\u003c/code\u003e is just a passthrough, its not totally necessary. But I chose to do it because as you will see below, our usage of higher order functions changes how we actually use our models in the rest of our code. So the \u003ccode\u003etenantlessModel\u003c/code\u003e function makes the usage standardized for all our models regardless of if they are isolated based on the current tenant.\u003c/p\u003e\n\u003ch3 id=\"usage\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#usage\"\u003e\u003ca href=\"#usage\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eUsage\u003c/h3\u003e\n\u003cp\u003eNow this does change how we actually use our models in the rest of our code. Because our default export in our models are higher order functions, we have to execute the returned function before we use each model.\u003c/p\u003e\n\u003cp\u003eFor example we can NO LONGER DO THIS:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ePage.find({})\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eInstead we have to do this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003ePage().find({})\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBut this actually turns out to be pretty useful. Remember that \u003ccode\u003eskipTenant\u003c/code\u003e thing before? We can actually pass options into our model function like \u003ccode\u003eskipTenant\u003c/code\u003e to customize our access to the model even further.\u003c/p\u003e\n\u003cp\u003eFor example to search EVERY user in our database, not just the ones associated with our current tenant we can do this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eUser({ skipTenant: true }).find({ _id: '123456' })\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"benefits\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#benefits\"\u003e\u003ca href=\"#benefits\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eBenefits\u003c/h3\u003e\n\u003cp\u003eYou'll notice that this implementation really doesn't require a lot of code.\u003c/p\u003e\n\u003cp\u003eIt also gives us a lot of useful abstraction layers to add extra behavior to our models.\u003c/p\u003e\n\u003cp\u003eBut, whats really great about this approach is that because we are always dealing with tenant isolated versions of every model, then any model that is created by a logged in user is \u003cstrong\u003eautomatically\u003c/strong\u003e assigned to the correct tenant.\u003c/p\u003e\n\u003cp\u003eAnd all queries and lookups are \u003cstrong\u003eautomatically\u003c/strong\u003e isolated to the tenant.\u003c/p\u003e\n\u003cp\u003eAnd it is basically nearly impossible for a user to view, list, update, create, or delete any model outside their own tenant because any mongoose function used to perform those actions is isolated to the users tenant from the get go.\u003c/p\u003e\n\u003cp\u003eWe don't have to rely on developers coding correct logic. And we can easily add other authentication logic on top of it and be confident our tenant isolation is secure.\u003c/p\u003e\n\u003ch3 id=\"extra-customization\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#extra-customization\"\u003e\u003ca href=\"#extra-customization\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eExtra Customization\u003c/h3\u003e\n\u003cp\u003eBecause our higher order functions have access to the schema of each model, we can do lots of things to our models. For example we can add new middleware to any model that has a tenant. Here's just one simple example of making sure every \u003ccode\u003etenantModel\u003c/code\u003e has a tenant using the before save mongoose middleware:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eexport function tenantModel(name, schema, options) {\n  return (props = {}) =\u003e {\n    schema.add({ tenantId: String });\n\n    schema.pre('save', function (next) {\n      if (!this.tenantId) {\n        const defaultTenantId = // find tenant\n        this.tenantId = defaultTenantId;\n      }\n    });\n  \n    const Model = mongoose.model(name, schema, options);\n\n    // ...\n  };\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou can also insert some authorization logic in here. For example you could set the current user using Continuation-Local Storage and then if the user is an admin, return the unmodified model, like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eimport { getCurrentTenantId, getCurrentUser } from './storage';\n\nexport function tenantModel(name, schema, options) {\n  return (props = {}) =\u003e {\n    schema.add({ tenantId: String });\n    const Model = mongoose.model(name, schema, options);\n\n    if (getCurrentUser().isAdmin()) return Model;\n\n\t// ...\n  };\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"conclusion\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#conclusion\"\u003e\u003ca href=\"#conclusion\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eConclusion\u003c/h3\u003e\n\u003cp\u003eI hope this at least gives you some ideas of how to add a solid multi-tenant layer in your express/mongoose app.\u003c/p\u003e\n\u003cp\u003eAs always, if you notice any problems in my code or flaws in my approach, please let me know. I'm always looking to learn and improve.\u003c/p\u003e\n\u003cp\u003eThanks for reading!\u003c/p\u003e\n\u003cp\u003eThanks to these libraries for inspiration:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.npmjs.com/package/mongoose-multitenant\" title=\"https://www.npmjs.com/package/mongoose-multitenant\"\u003ehttps://www.npmjs.com/package/mongoose-multitenant\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.npmjs.com/package/mongoose-multitenant\" title=\"https://www.npmjs.com/package/mongoose-multitenant\"\u003ehttps://www.npmjs.com/package/mongoose-multitenancy\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e"])</script><script>self.__next_f.push([1,"c:[\"$\",\"div\",null,{\"className\":\"sm:px-8 post mt-16 lg:mt-32\",\"children\":[\"$\",\"div\",null,{\"className\":\"mx-auto w-full max-w-7xl lg:px-8\",\"children\":[\"$\",\"div\",null,{\"className\":\"relative px-4 sm:px-8 lg:px-12\",\"children\":[\"$\",\"div\",null,{\"className\":\"mx-auto max-w-2xl lg:max-w-5xl\",\"children\":[\"$\",\"div\",null,{\"className\":\"xl:relative\",\"children\":[\"$\",\"div\",null,{\"className\":\"mx-auto max-w-2xl\",\"children\":[\"$\",\"article\",null,{\"children\":[[\"$\",\"header\",null,{\"className\":\"flex flex-col\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-4xl font-bold font-bold tracking-tight sm:text-5xl\",\"children\":\"Multi Tenancy with Express/Mongoose\"}],[\"$\",\"div\",null,{\"className\":\"flex gap-3 pt-1\",\"children\":[[\"$\",\"time\",null,{\"dateTime\":\"2018-10-03\",\"className\":\"text-muted-foreground order-first flex items-center pr-2 text-base\",\"children\":[[\"$\",\"span\",null,{\"className\":\"h-4 w-0.5 rounded-full bg-zinc-200 dark:bg-zinc-500\"}],[\"$\",\"span\",null,{\"className\":\"ml-3\",\"children\":\"October 3, 2018\"}]]}],[\"$\",\"span\",null,{\"className\":\"text-muted-foreground\",\"children\":\"-\"}],[[\"$\",\"span\",\"mongoose\",{\"className\":\"text-muted-foreground/80\",\"children\":\"mongoose\"}],[\"$\",\"span\",\"express\",{\"className\":\"text-muted-foreground/80\",\"children\":\"express\"}],[\"$\",\"span\",\"node\",{\"className\":\"text-muted-foreground/80\",\"children\":\"node\"}],[\"$\",\"span\",\"javascript\",{\"className\":\"text-muted-foreground/80\",\"children\":\"javascript\"}]]]}],[\"$\",\"div\",null,{\"className\":\"text-accent-foreground pt-3 text-sm italic\",\"children\":[\"~\",\"10 min read\"]}]]}],[\"$\",\"div\",null,{\"className\":\"mt-8 prose dark:prose-invert\",\"data-mdx-content\":true,\"children\":[\"$\",\"div\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"$d\"}}]}]]}]}]}]}]}]}]}]\n"])</script><script>self.__next_f.push([1,"4:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"Multi Tenancy with Express/Mongoose - Spencer Sharp\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"I’m Spencer, a software designer and entrepreneur based in New York City. I’m the founder and CEO of Planetaria, where we develop technologies that empower regular people to explore space on their own terms.\"}],[\"$\",\"link\",\"4\",{\"rel\":\"alternate\",\"type\":\"application/rss+xml\",\"href\":\"undefined/feed.xml\"}]]\n"])</script><script>self.__next_f.push([1,"b:null\n"])</script><script>self.__next_f.push([1,""])</script></body></html>