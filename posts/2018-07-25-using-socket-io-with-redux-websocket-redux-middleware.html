<!DOCTYPE html><html lang="en" class="h-full antialiased"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="image" imageSrcSet="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=16&amp;q=75 16w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=32&amp;q=75 32w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=48&amp;q=75 48w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=64&amp;q=75 64w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=96&amp;q=75 96w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=128&amp;q=75 128w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=256&amp;q=75 256w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=384&amp;q=75 384w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=640&amp;q=75 640w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=750&amp;q=75 750w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=828&amp;q=75 828w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=1080&amp;q=75 1080w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=1200&amp;q=75 1200w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=1920&amp;q=75 1920w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=2048&amp;q=75 2048w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=3840&amp;q=75 3840w" imageSizes="2.25rem" fetchPriority="high"/><link rel="stylesheet" href="/_next/static/css/9d8f288a99c54fb3.css" crossorigin="" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-113544170b8b14d7.js" crossorigin=""/><script src="/_next/static/chunks/de8a8aed-ff24f23ca546a20c.js" async="" crossorigin=""></script><script src="/_next/static/chunks/362-edde6a9467fb7f3f.js" async="" crossorigin=""></script><script src="/_next/static/chunks/main-app-dca2b37e6b098eb8.js" async="" crossorigin=""></script><script src="/_next/static/chunks/736-93d26bf9f492bada.js" async=""></script><script src="/_next/static/chunks/545-972397648c423446.js" async=""></script><script src="/_next/static/chunks/871-e93f475163439fcd.js" async=""></script><script src="/_next/static/chunks/app/layout-58152a9375fe786b.js" async=""></script><script src="/_next/static/chunks/app/posts/page-6d06c0c42f2ef9eb.js" async=""></script><title>Using Socket.io with Redux - Websocket Redux Middleware - Spencer Sharp</title><meta name="description" content="I’m Spencer, a software designer and entrepreneur based in New York City. I’m the founder and CEO of Planetaria, where we develop technologies that empower regular people to explore space on their own terms."/><link rel="alternate" type="application/rss+xml" href="undefined/feed.xml"/><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" crossorigin="" noModule=""></script></head><body class="flex h-full"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><div class="flex w-full"><div class="relative flex w-full flex-col"><header class="pointer-events-none relative z-50 flex flex-none flex-col" style="height:var(--header-height);margin-bottom:var(--header-mb)"><div class="top-0 z-10 h-16 pt-6" style="position:var(--header-position)"><div class="sm:px-8 top-[var(--header-top,theme(spacing.6))] w-full" style="position:var(--header-inner-position)"><div class="mx-auto w-full max-w-7xl lg:px-8"><div class="relative px-4 sm:px-8 lg:px-12"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class="relative flex gap-4"><div class="flex flex-1"><div class="h-10 w-10 rounded-full bg-white/90 p-0.5 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur dark:bg-zinc-800/90 dark:ring-white/10"><a aria-label="Home" class="pointer-events-auto" href="/"><img alt="" fetchPriority="high" width="1000" height="1000" decoding="async" data-nimg="1" class="rounded-full bg-zinc-100 object-cover dark:bg-zinc-800 h-9 w-9" style="color:transparent" sizes="2.25rem" srcSet="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=16&amp;q=75 16w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=32&amp;q=75 32w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=48&amp;q=75 48w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=64&amp;q=75 64w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=96&amp;q=75 96w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=128&amp;q=75 128w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=256&amp;q=75 256w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=384&amp;q=75 384w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=640&amp;q=75 640w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=750&amp;q=75 750w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=828&amp;q=75 828w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=1080&amp;q=75 1080w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=1200&amp;q=75 1200w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=1920&amp;q=75 1920w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=2048&amp;q=75 2048w, /_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=3840&amp;q=75 3840w" src="/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Favatar.6206df77.jpg&amp;w=3840&amp;q=75"/></a></div></div><div class="flex flex-1 justify-end md:justify-center"><nav class="pointer-events-auto hidden md:block"><ul class="flex rounded-full bg-white/90 px-3 text-sm font-medium text-zinc-800 shadow-lg shadow-zinc-800/5 ring-1 ring-zinc-900/5 backdrop-blur dark:bg-zinc-800/90 dark:text-zinc-200 dark:ring-white/10"><li><a class="relative block px-3 py-2 transition hover:text-teal-500 dark:hover:text-teal-400" href="/about">About</a></li><li><a class="relative block px-3 py-2 transition hover:text-teal-500 dark:hover:text-teal-400" href="/posts">Blog</a></li><li><a class="relative block px-3 py-2 transition hover:text-teal-500 dark:hover:text-teal-400" href="/projects">Projects</a></li></ul></nav></div><div class="flex justify-end md:flex-1"><div class="pointer-events-auto"><button class="inline-flex items-center justify-center text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground rounded-md h-8 w-8 px-0" type="button" id="radix-:R75la:" aria-haspopup="menu" aria-expanded="false" data-state="closed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0"><circle cx="12" cy="12" r="4"></circle><path d="M12 3v1"></path><path d="M12 20v1"></path><path d="M3 12h1"></path><path d="M20 12h1"></path><path d="m18.364 5.636-.707.707"></path><path d="m6.343 17.657-.707.707"></path><path d="m5.636 5.636.707.707"></path><path d="m17.657 17.657.707.707"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg><span class="sr-only">Toggle theme</span></button></div></div></div></div></div></div></div></div></header><main class="flex-auto"><div class="sm:px-8 post mt-16 lg:mt-32"><div class="mx-auto w-full max-w-7xl lg:px-8"><div class="relative px-4 sm:px-8 lg:px-12"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class="xl:relative"><div class="mx-auto max-w-2xl"><article><header class="flex flex-col"><h1 class="text-4xl font-bold font-bold tracking-tight sm:text-5xl">Using Socket.io with Redux - Websocket Redux Middleware</h1><div class="flex gap-3 pt-1"><time dateTime="2018-08-21" class="text-muted-foreground order-first flex items-center pr-2 text-base"><span class="h-4 w-0.5 rounded-full bg-zinc-200 dark:bg-zinc-500"></span><span class="ml-3">August 21, 2018</span></time><span class="text-muted-foreground">-</span><span class="text-muted-foreground/80">javascript</span><span class="text-muted-foreground/80">react</span><span class="text-muted-foreground/80">redux</span><span class="text-muted-foreground/80">websockets</span><span class="text-muted-foreground/80">socket.io</span></div><div class="text-accent-foreground pt-3 text-sm italic">~<!-- -->5 min read</div></header><div class="mt-8 prose dark:prose-invert" data-mdx-content="true"><div><p>This article uses socket.io as the websocket library. If you want to see a version of this article using Rails' ActionCable library, <a href="/posts/making-redux-middleware-for-websockets" title="/posts/making-redux-middleware-for-websockets">click here</a></p>
<hr>
<p>Middleware is one of the most powerful and useful features of redux. If you're unfamiliar with redux middleware, it is a way to insert extra behavior into dispatched redux actions.</p>
<p>Today we're going to use it to make a clean and powerful way to manage our socket.io events. Basically we want to subscribe to specific events and then dispatch specific redux actions anytime those events are broadcast to us from the socket.io server.</p>
<p>{: .lead}<br>
&#x3C;!–-break-–></p>
<p>Check out the <a href="https://redux.js.org/advanced/middleware" title="https://redux.js.org/advanced/middleware">redux middleware documentation here</a> The code below is inspired by reading through the source of <a href="https://github.com/erikras/react-redux-universal-hot-example" title="https://github.com/erikras/react-redux-universal-hot-example">this example redux app</a>, specifically <a href="https://github.com/erikras/react-redux-universal-hot-example/blob/master/src/redux/middleware/clientMiddleware.js" title="https://github.com/erikras/react-redux-universal-hot-example/blob/master/src/redux/middleware/clientMiddleware.js">this middleware</a>, so you may also want to check that out as well.</p>
<h3 id="typical-redux-actions"><a aria-hidden="true" tabindex="-1" href="#typical-redux-actions"><a href="#typical-redux-actions" style="margin-right: 10px">#</a></a>Typical Redux Actions</h3>
<p>Redux actions, by default, looks like this:</p>
<pre><code>{ type: 'MY_ACTION_TYPE' ...some_data }
</code></pre>
<p>Redux actions have 1 required attribute, <code>type</code>. Anything else is just extra and is usually meant to be used by the reducer to mutate the state.</p>
<p>By using redux middleware we can define our own action patterns and structures. The middleware will check if the action has other specific attributes and handle that action differently than the others. That way all we have to do to trigger some custom redux behavior is dispatch an action with our specific attributes and it will automatically be handled differently.</p>
<p>Specifically we are going to create a new kind of action that will start listening for specific socket.io events and dispatch a new redux action anytime that event comes through from the server. We'll also be able to stop listening for any specific event.</p>
<h3 id="middleware-function"><a aria-hidden="true" tabindex="-1" href="#middleware-function"><a href="#middleware-function" style="margin-right: 10px">#</a></a>Middleware Function</h3>
<p>First lets make a middleware function, you'll want to export this function from a file. I called my file `socketMiddleware.js`:</p>
<pre><code>import io from 'socket.io-client';

export default function socketMiddleware() {
  const socket = io();

  return ({ dispatch }) => next => (action) => {
    if (typeof action === 'function') {
      return next(action);
    }

    const {
      event,
      leave,
      handle,
      ...rest
    } = action;

    if (!event) {
      return next(action);
    }

    if (leave) {
      socket.removeListener(event);
    }

    let handleEvent = handle;
    if (typeof handleEvent === 'string') {
      handleEvent = result => dispatch({ type: handle, result, ...rest });
    }
    return socket.on(event, handleEvent);
  };
}
</code></pre>
<p>Lets break down this code:</p>
<p>Basically we first skip our middleware if the action is a function or if there is no <code>event</code> attribute in our action.</p>
<p>Then if there is a <code>leave</code> attribute, then we remove the event listener</p>
<p>Else we create a new event listener.</p>
<p>But you will notice that we are doing some quick logic to check if the <code>handle</code> attribute is a string. And if it is, we are changing its value to a function that dispatches a new action with the received data. So basically our <code>received</code> attribute can take both an action type string or an actual function. This gives us an extra level of control over how we handle the data coming in from the socket.io server.</p>
<p>And any data that is sent from the socket.io server is included in the <code>result</code> attribute of the action. So the reducer can have easy access to any data the server sent. Also any extra action attributes (<code>...rest</code>) are just passed directly through to the dispatched action.</p>
<p>Also notice that the function that we are exporting is returning another function. This is an example of a <a href="https://en.wikipedia.org/wiki/Higher-order_function" title="https://en.wikipedia.org/wiki/Higher-order_function">Higher-order function</a> and is a very useful pattern in Javascript. We will execute the outside function when we apply the middleware to redux which will create the socket.io connection only once and give the inner function access to that connection going forward.</p>
<h3 id="add-middleware-to-redux"><a aria-hidden="true" tabindex="-1" href="#add-middleware-to-redux"><a href="#add-middleware-to-redux" style="margin-right: 10px">#</a></a>Add Middleware to Redux</h3>
<p>Then we have to apply our new middlware. Check the <a href="https://redux.js.org/advanced/middleware#attempt-6-naively-applying-the-middleware" title="https://redux.js.org/advanced/middleware#attempt-6-naively-applying-the-middleware">redux documentation</a> for how to do this. But you will probably need to do something like this when setting up your store:</p>
<pre><code>import { createStore, applyMiddleware } from 'redux';
import socketMiddleware from './middleware/socketMiddleware';
import rootReducer from './reducers/index';

const store = createStore(
  rootReducer,
  applyMiddleware(socketMiddleware())
);
</code></pre>
<p>Since other file is actually exporting a higher-order function, don't forget to execute the socketMiddleware function when applying it to redux. This will also create the socket.io connection only once when the store loads so we don't have to worry about creating a new connection every time.</p>
<h3 id="our-new-action-creators"><a aria-hidden="true" tabindex="-1" href="#our-new-action-creators"><a href="#our-new-action-creators" style="margin-right: 10px">#</a></a>Our New Action Creators</h3>
<p>We now have access to a new type of action that has new required attributes. If we dispatch an action with a <code>event</code> attribute it will trigger our socket middleware.</p>
<p>Here are some example action creators using our new middleware.</p>
<pre><code>export function subscribeMessages() {
  return {
    event: 'message',
    handle: NEW_MESSAGE,
  }
}

export function unsubscribeMessages() {
  return {
    event: 'message',
    leave: true,
  }
}

// Action creator with received function:
export function subscribeConversation() {
  return dispatch => dispatch({
    event: 'message',
    handle: data => dispatch({
      type: NEW_MESSAGE,
      payload: data.message,
    }),
  });
}
</code></pre>
<p>You'll notice these actions don't even have the required <code>type</code> attribute, this is because when they are dispatched we hijack the action and do out own thing, so these particular actions never makes it to the reducer.</p>
<p>Instead we have an <code>event</code>, and <code>handle</code> attribute required to start listening for an event, and <code>event</code> and <code>leave</code>, attributes to stop listening.</p>
<p>The important part here is that <code>handle</code> is either an action string to dispatch when new data comes in, or a function to run when new data comes in, but since that function can be another call to dispatch, we have the convenience of a useful default and the flexibility to do whatever we want.</p>
<h3 id="conclusion"><a aria-hidden="true" tabindex="-1" href="#conclusion"><a href="#conclusion" style="margin-right: 10px">#</a></a>Conclusion</h3>
<p>I'm now a huge fan of redux middleware, I love how it cleans up and simplifies doing complex repetitive things in our action creators.</p>
<p>Now we've set this up we can subscribe and unsubscribe to socket.io events really easily just by dispatching one of our new action creators.</p></div></div></article></div></div></div></div></div></div></main><footer class="mt-32 flex-none"><div class="sm:px-8"><div class="mx-auto w-full max-w-7xl lg:px-8"><div class="pb-16 pt-10"><div class="relative px-4 sm:px-8 lg:px-12"><div class="mx-auto max-w-2xl lg:max-w-5xl"><div class="flex flex-col items-center justify-between gap-6 sm:flex-row"><div class="flex flex-wrap justify-center gap-x-6 gap-y-1 text-sm font-medium text-zinc-800 dark:text-zinc-200"><a class="transition hover:text-teal-500 dark:hover:text-teal-400" href="/about">About</a><a class="transition hover:text-teal-500 dark:hover:text-teal-400" href="/projects">Projects</a><a class="transition hover:text-teal-500 dark:hover:text-teal-400" href="/speaking">Speaking</a><a class="transition hover:text-teal-500 dark:hover:text-teal-400" href="/uses">Uses</a></div><p class="text-sm text-zinc-400 dark:text-zinc-500">© <!-- -->2023<!-- --> Spencer Sharp. All rights reserved.</p></div></div></div></div></div></div></footer></div></div><script src="/_next/static/chunks/webpack-113544170b8b14d7.js" crossorigin="" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/9d8f288a99c54fb3.css\",\"style\",{\"crossOrigin\":\"\"}]\n0:\"$L2\"\n"])</script><script>self.__next_f.push([1,"3:I[7483,[],\"\"]\n5:I[655,[],\"\"]\n6:I[2286,[\"736\",\"static/chunks/736-93d26bf9f492bada.js\",\"545\",\"static/chunks/545-972397648c423446.js\",\"871\",\"static/chunks/871-e93f475163439fcd.js\",\"185\",\"static/chunks/app/layout-58152a9375fe786b.js\"],\"ThemeProvider\"]\n7:I[7019,[\"736\",\"static/chunks/736-93d26bf9f492bada.js\",\"545\",\"static/chunks/545-972397648c423446.js\",\"871\",\"static/chunks/871-e93f475163439fcd.js\",\"185\",\"static/chunks/app/layout-58152a9375fe786b.js\"],\"Header\"]\n8:I[3849,[],\"\"]\n9:I[8656,[],\"\"]\na:I[4736,[\"736\",\"s"])</script><script>self.__next_f.push([1,"tatic/chunks/736-93d26bf9f492bada.js\",\"991\",\"static/chunks/app/posts/page-6d06c0c42f2ef9eb.js\"],\"\"]\n"])</script><script>self.__next_f.push([1,"2:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/9d8f288a99c54fb3.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}]],[\"$\",\"$L3\",null,{\"buildId\":\"ukvsT-xGIrbijjiNPJuDN\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/posts/2018-07-25-using-socket-io-with-redux-websocket-redux-middleware\",\"initialTree\":[\"\",{\"children\":[\"posts\",{\"children\":[[\"slug\",\"2018-07-25-using-socket-io-with-redux-websocket-redux-middleware\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"2018-07-25-using-socket-io-with-redux-websocket-redux-middleware\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[false,\"$L4\"],\"globalErrorComponent\":\"$5\",\"children\":[null,[\"$\",\"html\",null,{\"lang\":\"en\",\"className\":\"h-full antialiased\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"body\",null,{\"className\":\"flex h-full\",\"children\":[\"$\",\"$L6\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"disableTransitionOnChange\":true,\"children\":[\"$\",\"div\",null,{\"className\":\"flex w-full\",\"children\":[\"$\",\"div\",null,{\"className\":\"relative flex w-full flex-col\",\"children\":[[\"$\",\"$L7\",null,{}],[\"$\",\"main\",null,{\"className\":\"flex-auto\",\"children\":[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[\"$\",\"div\",null,{\"className\":\"sm:px-8 flex h-full items-center pt-16 sm:pt-32\",\"children\":[\"$\",\"div\",null,{\"className\":\"mx-auto w-full max-w-7xl lg:px-8\",\"children\":[\"$\",\"div\",null,{\"className\":\"relative px-4 sm:px-8 lg:px-12\",\"children\":[\"$\",\"div\",null,{\"className\":\"mx-auto max-w-2xl lg:max-w-5xl\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex flex-col items-center\",\"children\":[[\"$\",\"p\",null,{\"className\":\"text-base font-semibold text-zinc-400 dark:text-zinc-500\",\"children\":\"404\"}],[\"$\",\"h1\",null,{\"className\":\"mt-4 text-4xl font-bold tracking-tight text-zinc-800 dark:text-zinc-100 sm:text-5xl\",\"children\":\"Page not found\"}],[\"$\",\"p\",null,{\"className\":\"mt-4 text-base text-zinc-600 dark:text-zinc-400\",\"children\":\"Sorry, we couldn’t find the page you’re looking for.\"}],[\"$\",\"$La\",null,{\"href\":\"/\",\"children\":[\"$\",\"button\",null,{\"className\":\"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 mt-4\",\"children\":\"Go back home\"}]}]]}]}]}]}]}],\"notFoundStyles\":[],\"childProp\":{\"current\":[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\",[\"slug\",\"2018-07-25-using-socket-io-with-redux-websocket-redux-middleware\",\"d\"],\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$Lb\",\"$Lc\",null],\"segment\":\"__PAGE__?{\\\"slug\\\":\\\"2018-07-25-using-socket-io-with-redux-websocket-redux-middleware\\\"}\"},\"styles\":null}],\"segment\":[\"slug\",\"2018-07-25-using-socket-io-with-redux-websocket-redux-middleware\",\"d\"]},\"styles\":null}],\"segment\":\"posts\"},\"styles\":null}]}],[\"$\",\"footer\",null,{\"className\":\"mt-32 flex-none\",\"children\":[\"$\",\"div\",null,{\"className\":\"sm:px-8\",\"children\":[\"$\",\"div\",null,{\"className\":\"mx-auto w-full max-w-7xl lg:px-8\",\"children\":[\"$\",\"div\",null,{\"className\":\"pb-16 pt-10\",\"children\":[\"$\",\"div\",null,{\"className\":\"relative px-4 sm:px-8 lg:px-12\",\"children\":[\"$\",\"div\",null,{\"className\":\"mx-auto max-w-2xl lg:max-w-5xl\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex flex-col items-center justify-between gap-6 sm:flex-row\",\"children\":[[\"$\",\"div\",null,{\"className\":\"flex flex-wrap justify-center gap-x-6 gap-y-1 text-sm font-medium text-zinc-800 dark:text-zinc-200\",\"children\":[[\"$\",\"$La\",null,{\"href\":\"/about\",\"className\":\"transition hover:text-teal-500 dark:hover:text-teal-400\",\"children\":\"About\"}],[\"$\",\"$La\",null,{\"href\":\"/projects\",\"className\":\"transition hover:text-teal-500 dark:hover:text-teal-400\",\"children\":\"Projects\"}],[\"$\",\"$La\",null,{\"href\":\"/speaking\",\"className\":\"transition hover:text-teal-500 dark:hover:text-teal-400\",\"children\":\"Speaking\"}],[\"$\",\"$La\",null,{\"href\":\"/uses\",\"className\":\"transition hover:text-teal-500 dark:hover:text-teal-400\",\"children\":\"Uses\"}]]}],[\"$\",\"p\",null,{\"className\":\"text-sm text-zinc-400 dark:text-zinc-500\",\"children\":[\"© \",2023,\" Spencer Sharp. All rights reserved.\"]}]]}]}]}]}]}]}]}]]}]}]}]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"d:T209f,"])</script><script>self.__next_f.push([1,"\u003cp\u003eThis article uses socket.io as the websocket library. If you want to see a version of this article using Rails' ActionCable library, \u003ca href=\"/posts/making-redux-middleware-for-websockets\" title=\"/posts/making-redux-middleware-for-websockets\"\u003eclick here\u003c/a\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eMiddleware is one of the most powerful and useful features of redux. If you're unfamiliar with redux middleware, it is a way to insert extra behavior into dispatched redux actions.\u003c/p\u003e\n\u003cp\u003eToday we're going to use it to make a clean and powerful way to manage our socket.io events. Basically we want to subscribe to specific events and then dispatch specific redux actions anytime those events are broadcast to us from the socket.io server.\u003c/p\u003e\n\u003cp\u003e{: .lead}\u003cbr\u003e\n\u0026#x3C;!–-break-–\u003e\u003c/p\u003e\n\u003cp\u003eCheck out the \u003ca href=\"https://redux.js.org/advanced/middleware\" title=\"https://redux.js.org/advanced/middleware\"\u003eredux middleware documentation here\u003c/a\u003e The code below is inspired by reading through the source of \u003ca href=\"https://github.com/erikras/react-redux-universal-hot-example\" title=\"https://github.com/erikras/react-redux-universal-hot-example\"\u003ethis example redux app\u003c/a\u003e, specifically \u003ca href=\"https://github.com/erikras/react-redux-universal-hot-example/blob/master/src/redux/middleware/clientMiddleware.js\" title=\"https://github.com/erikras/react-redux-universal-hot-example/blob/master/src/redux/middleware/clientMiddleware.js\"\u003ethis middleware\u003c/a\u003e, so you may also want to check that out as well.\u003c/p\u003e\n\u003ch3 id=\"typical-redux-actions\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#typical-redux-actions\"\u003e\u003ca href=\"#typical-redux-actions\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eTypical Redux Actions\u003c/h3\u003e\n\u003cp\u003eRedux actions, by default, looks like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e{ type: 'MY_ACTION_TYPE' ...some_data }\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eRedux actions have 1 required attribute, \u003ccode\u003etype\u003c/code\u003e. Anything else is just extra and is usually meant to be used by the reducer to mutate the state.\u003c/p\u003e\n\u003cp\u003eBy using redux middleware we can define our own action patterns and structures. The middleware will check if the action has other specific attributes and handle that action differently than the others. That way all we have to do to trigger some custom redux behavior is dispatch an action with our specific attributes and it will automatically be handled differently.\u003c/p\u003e\n\u003cp\u003eSpecifically we are going to create a new kind of action that will start listening for specific socket.io events and dispatch a new redux action anytime that event comes through from the server. We'll also be able to stop listening for any specific event.\u003c/p\u003e\n\u003ch3 id=\"middleware-function\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#middleware-function\"\u003e\u003ca href=\"#middleware-function\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eMiddleware Function\u003c/h3\u003e\n\u003cp\u003eFirst lets make a middleware function, you'll want to export this function from a file. I called my file `socketMiddleware.js`:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eimport io from 'socket.io-client';\n\nexport default function socketMiddleware() {\n  const socket = io();\n\n  return ({ dispatch }) =\u003e next =\u003e (action) =\u003e {\n    if (typeof action === 'function') {\n      return next(action);\n    }\n\n    const {\n      event,\n      leave,\n      handle,\n      ...rest\n    } = action;\n\n    if (!event) {\n      return next(action);\n    }\n\n    if (leave) {\n      socket.removeListener(event);\n    }\n\n    let handleEvent = handle;\n    if (typeof handleEvent === 'string') {\n      handleEvent = result =\u003e dispatch({ type: handle, result, ...rest });\n    }\n    return socket.on(event, handleEvent);\n  };\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eLets break down this code:\u003c/p\u003e\n\u003cp\u003eBasically we first skip our middleware if the action is a function or if there is no \u003ccode\u003eevent\u003c/code\u003e attribute in our action.\u003c/p\u003e\n\u003cp\u003eThen if there is a \u003ccode\u003eleave\u003c/code\u003e attribute, then we remove the event listener\u003c/p\u003e\n\u003cp\u003eElse we create a new event listener.\u003c/p\u003e\n\u003cp\u003eBut you will notice that we are doing some quick logic to check if the \u003ccode\u003ehandle\u003c/code\u003e attribute is a string. And if it is, we are changing its value to a function that dispatches a new action with the received data. So basically our \u003ccode\u003ereceived\u003c/code\u003e attribute can take both an action type string or an actual function. This gives us an extra level of control over how we handle the data coming in from the socket.io server.\u003c/p\u003e\n\u003cp\u003eAnd any data that is sent from the socket.io server is included in the \u003ccode\u003eresult\u003c/code\u003e attribute of the action. So the reducer can have easy access to any data the server sent. Also any extra action attributes (\u003ccode\u003e...rest\u003c/code\u003e) are just passed directly through to the dispatched action.\u003c/p\u003e\n\u003cp\u003eAlso notice that the function that we are exporting is returning another function. This is an example of a \u003ca href=\"https://en.wikipedia.org/wiki/Higher-order_function\" title=\"https://en.wikipedia.org/wiki/Higher-order_function\"\u003eHigher-order function\u003c/a\u003e and is a very useful pattern in Javascript. We will execute the outside function when we apply the middleware to redux which will create the socket.io connection only once and give the inner function access to that connection going forward.\u003c/p\u003e\n\u003ch3 id=\"add-middleware-to-redux\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#add-middleware-to-redux\"\u003e\u003ca href=\"#add-middleware-to-redux\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eAdd Middleware to Redux\u003c/h3\u003e\n\u003cp\u003eThen we have to apply our new middlware. Check the \u003ca href=\"https://redux.js.org/advanced/middleware#attempt-6-naively-applying-the-middleware\" title=\"https://redux.js.org/advanced/middleware#attempt-6-naively-applying-the-middleware\"\u003eredux documentation\u003c/a\u003e for how to do this. But you will probably need to do something like this when setting up your store:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eimport { createStore, applyMiddleware } from 'redux';\nimport socketMiddleware from './middleware/socketMiddleware';\nimport rootReducer from './reducers/index';\n\nconst store = createStore(\n  rootReducer,\n  applyMiddleware(socketMiddleware())\n);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSince other file is actually exporting a higher-order function, don't forget to execute the socketMiddleware function when applying it to redux. This will also create the socket.io connection only once when the store loads so we don't have to worry about creating a new connection every time.\u003c/p\u003e\n\u003ch3 id=\"our-new-action-creators\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#our-new-action-creators\"\u003e\u003ca href=\"#our-new-action-creators\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eOur New Action Creators\u003c/h3\u003e\n\u003cp\u003eWe now have access to a new type of action that has new required attributes. If we dispatch an action with a \u003ccode\u003eevent\u003c/code\u003e attribute it will trigger our socket middleware.\u003c/p\u003e\n\u003cp\u003eHere are some example action creators using our new middleware.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eexport function subscribeMessages() {\n  return {\n    event: 'message',\n    handle: NEW_MESSAGE,\n  }\n}\n\nexport function unsubscribeMessages() {\n  return {\n    event: 'message',\n    leave: true,\n  }\n}\n\n// Action creator with received function:\nexport function subscribeConversation() {\n  return dispatch =\u003e dispatch({\n    event: 'message',\n    handle: data =\u003e dispatch({\n      type: NEW_MESSAGE,\n      payload: data.message,\n    }),\n  });\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou'll notice these actions don't even have the required \u003ccode\u003etype\u003c/code\u003e attribute, this is because when they are dispatched we hijack the action and do out own thing, so these particular actions never makes it to the reducer.\u003c/p\u003e\n\u003cp\u003eInstead we have an \u003ccode\u003eevent\u003c/code\u003e, and \u003ccode\u003ehandle\u003c/code\u003e attribute required to start listening for an event, and \u003ccode\u003eevent\u003c/code\u003e and \u003ccode\u003eleave\u003c/code\u003e, attributes to stop listening.\u003c/p\u003e\n\u003cp\u003eThe important part here is that \u003ccode\u003ehandle\u003c/code\u003e is either an action string to dispatch when new data comes in, or a function to run when new data comes in, but since that function can be another call to dispatch, we have the convenience of a useful default and the flexibility to do whatever we want.\u003c/p\u003e\n\u003ch3 id=\"conclusion\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#conclusion\"\u003e\u003ca href=\"#conclusion\" style=\"margin-right: 10px\"\u003e#\u003c/a\u003e\u003c/a\u003eConclusion\u003c/h3\u003e\n\u003cp\u003eI'm now a huge fan of redux middleware, I love how it cleans up and simplifies doing complex repetitive things in our action creators.\u003c/p\u003e\n\u003cp\u003eNow we've set this up we can subscribe and unsubscribe to socket.io events really easily just by dispatching one of our new action creators.\u003c/p\u003e"])</script><script>self.__next_f.push([1,"c:[\"$\",\"div\",null,{\"className\":\"sm:px-8 post mt-16 lg:mt-32\",\"children\":[\"$\",\"div\",null,{\"className\":\"mx-auto w-full max-w-7xl lg:px-8\",\"children\":[\"$\",\"div\",null,{\"className\":\"relative px-4 sm:px-8 lg:px-12\",\"children\":[\"$\",\"div\",null,{\"className\":\"mx-auto max-w-2xl lg:max-w-5xl\",\"children\":[\"$\",\"div\",null,{\"className\":\"xl:relative\",\"children\":[\"$\",\"div\",null,{\"className\":\"mx-auto max-w-2xl\",\"children\":[\"$\",\"article\",null,{\"children\":[[\"$\",\"header\",null,{\"className\":\"flex flex-col\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"text-4xl font-bold font-bold tracking-tight sm:text-5xl\",\"children\":\"Using Socket.io with Redux - Websocket Redux Middleware\"}],[\"$\",\"div\",null,{\"className\":\"flex gap-3 pt-1\",\"children\":[[\"$\",\"time\",null,{\"dateTime\":\"2018-08-21\",\"className\":\"text-muted-foreground order-first flex items-center pr-2 text-base\",\"children\":[[\"$\",\"span\",null,{\"className\":\"h-4 w-0.5 rounded-full bg-zinc-200 dark:bg-zinc-500\"}],[\"$\",\"span\",null,{\"className\":\"ml-3\",\"children\":\"August 21, 2018\"}]]}],[\"$\",\"span\",null,{\"className\":\"text-muted-foreground\",\"children\":\"-\"}],[[\"$\",\"span\",\"javascript\",{\"className\":\"text-muted-foreground/80\",\"children\":\"javascript\"}],[\"$\",\"span\",\"react\",{\"className\":\"text-muted-foreground/80\",\"children\":\"react\"}],[\"$\",\"span\",\"redux\",{\"className\":\"text-muted-foreground/80\",\"children\":\"redux\"}],[\"$\",\"span\",\"websockets\",{\"className\":\"text-muted-foreground/80\",\"children\":\"websockets\"}],[\"$\",\"span\",\"socket.io\",{\"className\":\"text-muted-foreground/80\",\"children\":\"socket.io\"}]]]}],[\"$\",\"div\",null,{\"className\":\"text-accent-foreground pt-3 text-sm italic\",\"children\":[\"~\",\"5 min read\"]}]]}],[\"$\",\"div\",null,{\"className\":\"mt-8 prose dark:prose-invert\",\"data-mdx-content\":true,\"children\":[\"$\",\"div\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"$d\"}}]}]]}]}]}]}]}]}]}]\n"])</script><script>self.__next_f.push([1,"4:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"Using Socket.io with Redux - Websocket Redux Middleware - Spencer Sharp\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"I’m Spencer, a software designer and entrepreneur based in New York City. I’m the founder and CEO of Planetaria, where we develop technologies that empower regular people to explore space on their own terms.\"}],[\"$\",\"link\",\"4\",{\"rel\":\"alternate\",\"type\":\"application/rss+xml\",\"href\":\"undefined/feed.xml\"}]]\n"])</script><script>self.__next_f.push([1,"b:null\n"])</script><script>self.__next_f.push([1,""])</script></body></html>