1:HL["/_next/static/css/9d8f288a99c54fb3.css","style",{"crossOrigin":""}]
0:["AzO8YmqLI-jVS4hv3vlbF",[[["",{"children":["posts",{"children":[["slug","2018-09-20-simple-object-storage-in-redis-and-node","d"],{"children":["__PAGE__?{\"slug\":\"2018-09-20-simple-object-storage-in-redis-and-node\"}",{}]}]}]},"$undefined","$undefined",true],"$L2",[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/9d8f288a99c54fb3.css","precedence":"next","crossOrigin":""}]],"$L3"]]]]
4:I[2286,["736","static/chunks/736-93d26bf9f492bada.js","545","static/chunks/545-972397648c423446.js","871","static/chunks/871-e93f475163439fcd.js","185","static/chunks/app/layout-58152a9375fe786b.js"],"ThemeProvider"]
5:I[7019,["736","static/chunks/736-93d26bf9f492bada.js","545","static/chunks/545-972397648c423446.js","871","static/chunks/871-e93f475163439fcd.js","185","static/chunks/app/layout-58152a9375fe786b.js"],"Header"]
6:I[3849,[],""]
7:I[8656,[],""]
8:I[4736,["736","static/chunks/736-93d26bf9f492bada.js","991","static/chunks/app/posts/page-6d06c0c42f2ef9eb.js"],""]
2:[null,["$","html",null,{"lang":"en","className":"h-full antialiased","suppressHydrationWarning":true,"children":["$","body",null,{"className":"flex h-full","children":["$","$L4",null,{"attribute":"class","defaultTheme":"system","enableSystem":true,"disableTransitionOnChange":true,"children":["$","div",null,{"className":"flex w-full","children":["$","div",null,{"className":"relative flex w-full flex-col","children":[["$","$L5",null,{}],["$","main",null,{"className":"flex-auto","children":["$","$L6",null,{"parallelRouterKey":"children","segmentPath":["children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L7",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":["$","div",null,{"className":"sm:px-8 flex h-full items-center pt-16 sm:pt-32","children":["$","div",null,{"className":"mx-auto w-full max-w-7xl lg:px-8","children":["$","div",null,{"className":"relative px-4 sm:px-8 lg:px-12","children":["$","div",null,{"className":"mx-auto max-w-2xl lg:max-w-5xl","children":["$","div",null,{"className":"flex flex-col items-center","children":[["$","p",null,{"className":"text-base font-semibold text-zinc-400 dark:text-zinc-500","children":"404"}],["$","h1",null,{"className":"mt-4 text-4xl font-bold tracking-tight text-zinc-800 dark:text-zinc-100 sm:text-5xl","children":"Page not found"}],["$","p",null,{"className":"mt-4 text-base text-zinc-600 dark:text-zinc-400","children":"Sorry, we couldn’t find the page you’re looking for."}],["$","$L8",null,{"href":"/","children":["$","button",null,{"className":"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 mt-4","children":"Go back home"}]}]]}]}]}]}]}],"notFoundStyles":[],"childProp":{"current":["$","$L6",null,{"parallelRouterKey":"children","segmentPath":["children","posts","children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L7",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$","$L6",null,{"parallelRouterKey":"children","segmentPath":["children","posts","children",["slug","2018-09-20-simple-object-storage-in-redis-and-node","d"],"children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L7",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","childProp":{"current":["$L9","$La",null],"segment":"__PAGE__?{\"slug\":\"2018-09-20-simple-object-storage-in-redis-and-node\"}"},"styles":null}],"segment":["slug","2018-09-20-simple-object-storage-in-redis-and-node","d"]},"styles":null}],"segment":"posts"},"styles":null}]}],["$","footer",null,{"className":"mt-32 flex-none","children":["$","div",null,{"className":"sm:px-8","children":["$","div",null,{"className":"mx-auto w-full max-w-7xl lg:px-8","children":["$","div",null,{"className":"pb-16 pt-10","children":["$","div",null,{"className":"relative px-4 sm:px-8 lg:px-12","children":["$","div",null,{"className":"mx-auto max-w-2xl lg:max-w-5xl","children":["$","div",null,{"className":"flex flex-col items-center justify-between gap-6 sm:flex-row","children":[["$","div",null,{"className":"flex flex-wrap justify-center gap-x-6 gap-y-1 text-sm font-medium text-zinc-800 dark:text-zinc-200","children":[["$","$L8",null,{"href":"/about","className":"transition hover:text-teal-500 dark:hover:text-teal-400","children":"About"}],["$","$L8",null,{"href":"/projects","className":"transition hover:text-teal-500 dark:hover:text-teal-400","children":"Projects"}],["$","$L8",null,{"href":"/speaking","className":"transition hover:text-teal-500 dark:hover:text-teal-400","children":"Speaking"}],["$","$L8",null,{"href":"/uses","className":"transition hover:text-teal-500 dark:hover:text-teal-400","children":"Uses"}]]}],["$","p",null,{"className":"text-sm text-zinc-400 dark:text-zinc-500","children":["© ",2023," Spencer Sharp. All rights reserved."]}]]}]}]}]}]}]}]}]]}]}]}]}]}],null]
b:T19ae8,<p><strong>First</strong> it was important for our use case to have some basic kind of indexing and sorting based on when the document was created.</p>
<p><strong>Second</strong>, since we do a lot of logging, we needed to make sure that all documents clean up after themselves and expire nicely so we don't run out of space in redis, and we don't really care about keeping these logs indefinitely.</p>
<p><strong>Third</strong>, our logs are javascript objects, so we needed some kind of customizable serialization/deserialization.</p>
<p><strong>Fourth</strong>, I wanted to have a nice abstraction with predictable model-like behavior like <code>findOne</code>, <code>create</code>, <code>update</code>, and <code>fromIndex</code>.</p>
<p>So here is a basic solution I came up with.</p>
<p>The plan:</p>
<ul>
<li><strong>Schema</strong> - Add a schema for <code>redisModels</code></li>
<li><strong>Finding, Creating and Updating</strong> - Use <a href="">redis hashes</a> to store our objects and have functions for adding, finding, and updating.</li>
<li><strong>Indexing and Sorting</strong> - Use <a href="https://redis.io/topics/data-types#lists" title="https://redis.io/topics/data-types#lists">redis lists</a> (aka ranges) to maintain a sorted list of object keys.</li>
</ul>
<p>I'll be using the main <a href="https://www.npmjs.com/package/redis" title="https://www.npmjs.com/package/redis">redis node</a> library for this.</p>
<h3 id="schema"><a aria-hidden="true" tabindex="-1" href="#schema"><a href="#schema" style="margin-right: 10px">#</a></a>Schema</h3>
<p>Here is what our basic schema will look like:</p>
<pre class="shiki poimandres" style="background-color: #1b1e28" tabindex="0"><code><span class="line"><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">logSchema</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">namespace</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">logs</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">indexes</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">[</span></span>
<span class="line"><span style="color: #ADD7FF">    </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #E4F0FB">      </span><span style="color: #ADD7FF">getName</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">()</span><span style="color: #ADD7FF"> </span><span style="color: #91B4D5">=></span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">createdAt</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #E4F0FB">      </span><span style="color: #ADD7FF">shouldIndex</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">()</span><span style="color: #ADD7FF"> </span><span style="color: #91B4D5">=></span><span style="color: #ADD7FF"> </span><span style="color: #5DE4C7">true</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #E4F0FB">      </span><span style="color: #ADD7FF">addNonTenantIndex</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">()</span><span style="color: #ADD7FF"> </span><span style="color: #91B4D5">=></span><span style="color: #ADD7FF"> </span><span style="color: #5DE4C7">true</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #E4F0FB">      </span><span style="color: #ADD7FF">getValue</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">data</span><span style="color: #ADD7FF"> </span><span style="color: #91B4D5">=></span><span style="color: #ADD7FF"> </span><span style="color: #5DE4C7">new</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FBD0">Date</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">createdAt</span><span style="color: #A6ACCD">).</span><span style="color: #E4F0FBD0">getTime</span><span style="color: #A6ACCD">(),</span></span>
<span class="line"><span style="color: #E4F0FB">    </span><span style="color: #A6ACCD">},</span></span>
<span class="line"><span style="color: #ADD7FF">  </span><span style="color: #A6ACCD">],</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">attributes</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #E4F0FB">    </span><span style="color: #ADD7FF">source</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">{</span><span style="color: #E4F0FB"> </span><span style="color: #ADD7FF">kind</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">string</span><span style="color: #A6ACCD">'</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">},</span></span>
<span class="line"><span style="color: #E4F0FB">    </span><span style="color: #ADD7FF">user</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">{</span><span style="color: #E4F0FB"> </span><span style="color: #ADD7FF">kind</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">object</span><span style="color: #A6ACCD">'</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">},</span></span>
<span class="line"><span style="color: #E4F0FB">    </span><span style="color: #ADD7FF">body</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">{</span><span style="color: #E4F0FB"> </span><span style="color: #ADD7FF">kind</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">object</span><span style="color: #A6ACCD">'</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">},</span></span>
<span class="line"><span style="color: #E4F0FB">    </span><span style="color: #ADD7FF">createdAt</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">{</span><span style="color: #E4F0FB"> </span><span style="color: #ADD7FF">kind</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">time</span><span style="color: #A6ACCD">'</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">},</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #A6ACCD">},</span></span>
<span class="line"><span style="color: #A6ACCD">};</span></span></code></pre>
<p>As you can see we set information about our <code>attributes</code>, <code>indexes</code> and a <code>namespace</code> that we will use for our redis keys. The <code>namespace</code> is mostly useful if you plan on storing multiple kinds of objects in redis.</p>
<h3 id="creating"><a aria-hidden="true" tabindex="-1" href="#creating"><a href="#creating" style="margin-right: 10px">#</a></a>Creating</h3>
<p>We'll start by creating a new class and constructor inside of a new file called <code>lib/redis.js</code>. I know this is a bunch of code to dump in all at once, but I'll break it down afterwards:</p>
<pre class="shiki poimandres" style="background-color: #1b1e28" tabindex="0"><code><span class="line"><span style="color: #5DE4C7">import </span><span style="color: #ADD7FF">shortid</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">from</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">shortid</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #5DE4C7">import </span><span style="color: #ADD7FF">_</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">from</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">lodash</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #91B4D5">function</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">getRedisClient</span><span style="color: #A6ACCD">() {</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #767C9DB0; font-style: italic">// IMPLEMENT YOUR OWN METHOD OF GETTING THE REDIS CLIENT,</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #91B4D5">function</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">expSeconds</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">days</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">30</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">secondsPerDay</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">86400</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #5DE4C7C0">return</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">days</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">*</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">secondsPerDay</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #91B4D5">function</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">buildId</span><span style="color: #A6ACCD">() { </span><span style="color: #5DE4C7C0">return</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">shortid</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">generate</span><span style="color: #A6ACCD">(); }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">stringify</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">string</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">data</span><span style="color: #ADD7FF"> </span><span style="color: #91B4D5">=></span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">number</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">data</span><span style="color: #ADD7FF"> </span><span style="color: #91B4D5">=></span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">toString</span><span style="color: #A6ACCD">(),</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">date</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">data</span><span style="color: #ADD7FF"> </span><span style="color: #91B4D5">=></span><span style="color: #ADD7FF"> </span><span style="color: #5DE4C7">new</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FBD0">Date</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">).</span><span style="color: #E4F0FBD0">toISOString</span><span style="color: #A6ACCD">(),</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">time</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">data</span><span style="color: #ADD7FF"> </span><span style="color: #91B4D5">=></span><span style="color: #ADD7FF"> </span><span style="color: #5DE4C7">new</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FBD0">Date</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">).</span><span style="color: #E4F0FBD0">toISOString</span><span style="color: #A6ACCD">(),</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">object</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">data</span><span style="color: #ADD7FF"> </span><span style="color: #91B4D5">=></span><span style="color: #ADD7FF"> JSON</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">stringify</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">),</span></span>
<span class="line"><span style="color: #A6ACCD">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">export default </span><span style="color: #91B4D5">class</span><span style="color: #5DE4C7"> </span><span style="color: #ADD7FF">RedisModel</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #91B4D5">constructor</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">schema</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">props</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #E4F0FB"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #E4F0FB">      schema</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #E4F0FB">      </span><span style="color: #ADD7FF">client</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FBD0">getRedisClient</span><span style="color: #A6ACCD">(),</span></span>
<span class="line"><span style="color: #E4F0FB">    </span><span style="color: #A6ACCD">};</span></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #A6ACCD">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #ADD7FF">_buildHashValues</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span><span style="color: #5DE4C7"> schema</span><span style="color: #A6ACCD">:</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">attributes</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">}</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">}</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">props</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">hashValues</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">[];</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #E4F0FB">_</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">each</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">value</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">key</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=></span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">type</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">attributes</span><span style="color: #A6ACCD">[</span><span style="color: #E4F0FB">key</span><span style="color: #A6ACCD">]</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">||</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{}).</span><span style="color: #E4F0FB">kind</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">stringValue</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">stringify</span><span style="color: #A6ACCD">[</span><span style="color: #E4F0FB">type</span><span style="color: #A6ACCD">]</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">?</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">stringify</span><span style="color: #A6ACCD">[</span><span style="color: #E4F0FB">type</span><span style="color: #A6ACCD">](</span><span style="color: #E4F0FB">value</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">:</span><span style="color: #5DE4C7"> </span><span style="color: #D0679D">undefined</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #A6ACCD">if</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">(</span><span style="color: #91B4D5">!</span><span style="color: #E4F0FB">type</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">||</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">!</span><span style="color: #E4F0FB">stringValue</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #D0679D">null</span><span style="color: #A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">hashValues</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">push</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">key</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">stringValue</span><span style="color: #A6ACCD">);</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #A6ACCD">});</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">_</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">isEmpty</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">hashValues</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">?</span><span style="color: #5DE4C7"> </span><span style="color: #D0679D">undefined</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">:</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">hashValues</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #A6ACCD">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #ADD7FF">_buildRedisKey</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">id</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">schema</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">}</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">props</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">`${</span><span style="color: #E4F0FB">schema</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">namespace</span><span style="color: #A6ACCD">}</span><span style="color: #5DE4C7">:</span><span style="color: #A6ACCD">${</span><span style="color: #E4F0FB">id</span><span style="color: #A6ACCD">}`</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #A6ACCD">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #ADD7FF">create</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">client</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">}</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">props</span><span style="color: #A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> new </span><span style="color: #ADD7FF">Promise</span><span style="color: #A6ACCD">((</span><span style="color: #E4F0FB">resolve</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">reject</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=></span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">multi</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">client</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">multi</span><span style="color: #A6ACCD">();</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">id</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FBD0">buildId</span><span style="color: #A6ACCD">();</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">redisKey</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">_buildRedisKey</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">id</span><span style="color: #A6ACCD">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #767C9DB0; font-style: italic">// Handle the hash values</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">hashValues</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">_buildHashValues</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">);</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #A6ACCD">if</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">hashValues</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">        </span><span style="color: #E4F0FB">multi</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">hmset</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">redisKey</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">hashValues</span><span style="color: #A6ACCD">);</span></span>
<span class="line"><span style="color: #5DE4C7">        </span><span style="color: #E4F0FB">multi</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">hmset</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">redisKey</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">EX</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FBD0">expSeconds</span><span style="color: #A6ACCD">());</span></span>
<span class="line"><span style="color: #5DE4C7">        </span><span style="color: #E4F0FB">multi</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">exec</span><span style="color: #A6ACCD">((</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=></span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">          </span><span style="color: #A6ACCD">if</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FBD0">reject</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">          </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FBD0">resolve</span><span style="color: #A6ACCD">({</span><span style="color: #E4F0FB"> </span><span style="color: #ADD7FF">key</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">redisKey</span><span style="color: #A6ACCD">,</span><span style="color: #E4F0FB"> </span><span style="color: #ADD7FF">_id</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">id</span><span style="color: #A6ACCD">,</span><span style="color: #E4F0FB"> </span><span style="color: #91B4D5">...</span><span style="color: #E4F0FB">data</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">});</span></span>
<span class="line"><span style="color: #5DE4C7">        </span><span style="color: #A6ACCD">});</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #A6ACCD">}</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">else</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">        </span><span style="color: #E4F0FBD0">reject</span><span style="color: #A6ACCD">(</span><span style="color: #5DE4C7">new </span><span style="color: #E4F0FBD0">Error</span><span style="color: #A6ACCD">(</span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">Empty redis hash data</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">));</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #A6ACCD">}</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #A6ACCD">});</span></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #A6ACCD">}</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span></code></pre>
<p>First of all you'll notice I'm using the <a href="">lodash</a> for its useful helper methods, and <a href="https://www.npmjs.com/package/shortid" title="https://www.npmjs.com/package/shortid">shortid</a> to help generate unique ids for our redis keys.</p>
<p>We are using the <code>multi</code> redis behavior.</p>
<pre class="shiki poimandres" style="background-color: #1b1e28" tabindex="0"><code><span class="line"><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">multi</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">client</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">multi</span><span style="color: #A6ACCD">();</span></span>
<span class="line"><span style="color: #767C9DB0; font-style: italic">// ...</span></span>
<span class="line"><span style="color: #E4F0FB">multi</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">hmset</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">redisKey</span><span style="color: #A6ACCD">, </span><span style="color: #E4F0FB">hashValues</span><span style="color: #A6ACCD">);</span></span>
<span class="line"><span style="color: #E4F0FB">multi</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">hmset</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">redisKey</span><span style="color: #A6ACCD">, </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">EX</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">, </span><span style="color: #E4F0FBD0">expSeconds</span><span style="color: #A6ACCD">());</span></span>
<span class="line"><span style="color: #E4F0FB">multi</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">exec</span><span style="color: #A6ACCD">((</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">) </span><span style="color: #91B4D5">=></span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #767C9DB0; font-style: italic">// ...</span></span></code></pre>
<p>This allows us to do multiple calls in one redis transaction, and if one of the calls fails, the whole transaction will fail. This reduces the chances that we'll have stray data being stored in the database.</p>
<p>We're also using our schema namespace to build a unique redis key for our object.</p>
<pre class="shiki poimandres" style="background-color: #1b1e28" tabindex="0"><code><span class="line"><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">redisKey</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">_buildRedisKey</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">id</span><span style="color: #A6ACCD">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #E4F0FBD0">_buildRedisKey</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">id</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> { </span><span style="color: #E4F0FB">schema</span><span style="color: #A6ACCD"> } </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">props</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #5DE4C7C0">return</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCD">`${</span><span style="color: #E4F0FB">schema</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">namespace</span><span style="color: #A6ACCD">}</span><span style="color: #5DE4C7">:</span><span style="color: #A6ACCD">${</span><span style="color: #E4F0FB">id</span><span style="color: #A6ACCD">}`</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #A6ACCD">  }</span></span></code></pre>
<p>This isn't totally necessary, and really only useful if you are storing multiple types of objects in redis, but it does give us the ability to do basic fetching redis for all items with the namespace prefix later if we want.</p>
<p>You can see that we're using a <a href="https://redis.io/topics/data-types#hashes" title="https://redis.io/topics/data-types#hashes">redis hash</a> to store all our object data.</p>
<pre><code>multi.hmset(redisKey, hashValues);
</code></pre>
<p>The <a href="https://redis.io/commands/hmset" title="https://redis.io/commands/hmset">hmset</a> function takes an array of key value pairs. Redis hashes require the values to be strings, so our <code>_buildHashValues</code> function takes our data and converts it to an array of strings based on the key/value pairs and attribute types in the schema.</p>
<pre class="shiki poimandres" style="background-color: #1b1e28" tabindex="0"><code><span class="line"><span style="color: #E4F0FBD0">_buildHashValues</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> { schema: { </span><span style="color: #E4F0FB">attributes</span><span style="color: #A6ACCD"> } } </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">props</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">hashValues</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> [];</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #E4F0FB">_</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">each</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">, (</span><span style="color: #E4F0FB">value</span><span style="color: #A6ACCD">, </span><span style="color: #E4F0FB">key</span><span style="color: #A6ACCD">) </span><span style="color: #91B4D5">=></span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">type</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> (</span><span style="color: #E4F0FB">attributes</span><span style="color: #A6ACCD">[</span><span style="color: #E4F0FB">key</span><span style="color: #A6ACCD">] </span><span style="color: #91B4D5">||</span><span style="color: #A6ACCD"> {}).</span><span style="color: #E4F0FB">kind</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">stringValue</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">stringify</span><span style="color: #A6ACCD">[</span><span style="color: #E4F0FB">type</span><span style="color: #A6ACCD">] </span><span style="color: #91B4D5">?</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">stringify</span><span style="color: #A6ACCD">[</span><span style="color: #E4F0FB">type</span><span style="color: #A6ACCD">](</span><span style="color: #E4F0FB">value</span><span style="color: #A6ACCD">) </span><span style="color: #91B4D5">:</span><span style="color: #A6ACCD"> </span><span style="color: #D0679D">undefined</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #A6ACCD">    if (</span><span style="color: #91B4D5">!</span><span style="color: #E4F0FB">type</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">||</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">!</span><span style="color: #E4F0FB">stringValue</span><span style="color: #A6ACCD">) </span><span style="color: #5DE4C7C0">return</span><span style="color: #A6ACCD"> </span><span style="color: #D0679D">null</span><span style="color: #A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #5DE4C7C0">return</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">hashValues</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">push</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">key</span><span style="color: #A6ACCD">, </span><span style="color: #E4F0FB">stringValue</span><span style="color: #A6ACCD">);</span></span>
<span class="line"><span style="color: #A6ACCD">  });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #5DE4C7C0">return</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">_</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">isEmpty</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">hashValues</span><span style="color: #A6ACCD">) </span><span style="color: #91B4D5">?</span><span style="color: #A6ACCD"> </span><span style="color: #D0679D">undefined</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">:</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">hashValues</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span></code></pre>
<p>And it uses our <code>stringify</code> object as a map for how to convert the different attributes to strings based on the schema. This gives us some granular control over the serialization of each attribute of our objects.</p>
<p>And we're also setting an expiration for our keys so they dont last forever in our database.</p>
<pre class="shiki poimandres" style="background-color: #1b1e28" tabindex="0"><code><span class="line"><span style="color: #E4F0FB">multi</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">hmset</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">redisKey</span><span style="color: #A6ACCD">, </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">EX</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">, </span><span style="color: #E4F0FBD0">expSeconds</span><span style="color: #A6ACCD">());</span></span></code></pre>
<p>And that handles our ability to create new objects in our redis model.</p>
<h3 id="updating"><a aria-hidden="true" tabindex="-1" href="#updating"><a href="#updating" style="margin-right: 10px">#</a></a>Updating</h3>
<p>Our update function is very similar to our create:</p>
<pre class="shiki poimandres" style="background-color: #1b1e28" tabindex="0"><code><span class="line"><span style="color: #5DE4C7">export default </span><span style="color: #91B4D5">class</span><span style="color: #5DE4C7"> </span><span style="color: #ADD7FF">RedisModel</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #767C9DB0; font-style: italic">// ...</span></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #ADD7FF">update</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">id</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">client</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">}</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">props</span><span style="color: #A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> new </span><span style="color: #ADD7FF">Promise</span><span style="color: #A6ACCD">((</span><span style="color: #E4F0FB">resolve</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">reject</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=></span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">redisKey</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">_buildRedisKey</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">id</span><span style="color: #A6ACCD">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #767C9DB0; font-style: italic">// Handle the hash values</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">hashValues</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">_buildHashValues</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">);</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #A6ACCD">if</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">hashValues</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">        </span><span style="color: #E4F0FB">client</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">hmset</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">redisKey</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">hashValues</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=></span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">          </span><span style="color: #A6ACCD">if</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FBD0">reject</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">          </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FBD0">resolve</span><span style="color: #A6ACCD">();</span></span>
<span class="line"><span style="color: #5DE4C7">        </span><span style="color: #A6ACCD">});</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #A6ACCD">}</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">else</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FBD0">resolve</span><span style="color: #A6ACCD">();</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #A6ACCD">});</span></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #A6ACCD">}</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span></code></pre>
<p>Basically it uses the same <code>_buildRedisKey</code> function so we only have to deal with the id of the object. Then it basically just does the same <code>hmset</code> function. Redis will keep any attributes in the hash that are not overwritten.</p>
<h3 id="finding"><a aria-hidden="true" tabindex="-1" href="#finding"><a href="#finding" style="margin-right: 10px">#</a></a>Finding</h3>
<p>Here's our find method. This lets us find any object by id and deserialize all the values into their original datatypes based on the schema:</p>
<pre class="shiki poimandres" style="background-color: #1b1e28" tabindex="0"><code><span class="line"><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">parsify</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">string</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">data</span><span style="color: #ADD7FF"> </span><span style="color: #91B4D5">=></span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">number</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">data</span><span style="color: #ADD7FF"> </span><span style="color: #91B4D5">=></span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FBD0">parseInt</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">,</span><span style="color: #ADD7FF"> </span><span style="color: #5DE4C7">10</span><span style="color: #A6ACCD">),</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">date</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">data</span><span style="color: #ADD7FF"> </span><span style="color: #91B4D5">=></span><span style="color: #ADD7FF"> </span><span style="color: #5DE4C7">new</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FBD0">Date</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">),</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">time</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">data</span><span style="color: #ADD7FF"> </span><span style="color: #91B4D5">=></span><span style="color: #ADD7FF"> </span><span style="color: #5DE4C7">new</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FBD0">Date</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">),</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">object</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">data</span><span style="color: #ADD7FF"> </span><span style="color: #91B4D5">=></span><span style="color: #ADD7FF"> JSON</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">parse</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">),</span></span>
<span class="line"><span style="color: #A6ACCD">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">export default </span><span style="color: #91B4D5">class</span><span style="color: #5DE4C7"> </span><span style="color: #ADD7FF">RedisModel</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #767C9DB0; font-style: italic">// ...</span></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #ADD7FF">_unpackHashValues</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span><span style="color: #5DE4C7"> schema</span><span style="color: #A6ACCD">:</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">attributes</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">}</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">}</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">props</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">obj</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #E4F0FB">_</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">each</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">value</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">key</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=></span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">type</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">attributes</span><span style="color: #A6ACCD">[</span><span style="color: #E4F0FB">key</span><span style="color: #A6ACCD">]</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">||</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{}).</span><span style="color: #E4F0FB">kind</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #A6ACCD">if</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">(</span><span style="color: #91B4D5">!</span><span style="color: #E4F0FB">type</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #D0679D">null</span><span style="color: #A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #E4F0FB">obj</span><span style="color: #A6ACCD">[</span><span style="color: #E4F0FB">key</span><span style="color: #A6ACCD">]</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">parsify</span><span style="color: #A6ACCD">[</span><span style="color: #E4F0FB">type</span><span style="color: #A6ACCD">](</span><span style="color: #E4F0FB">value</span><span style="color: #A6ACCD">);</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #D0679D">null</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #A6ACCD">});</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">_</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">isEmpty</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">obj</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">?</span><span style="color: #5DE4C7"> </span><span style="color: #D0679D">undefined</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">:</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">obj</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #A6ACCD">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #ADD7FF">findOne</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">id</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">client</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">}</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">props</span><span style="color: #A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> new </span><span style="color: #ADD7FF">Promise</span><span style="color: #A6ACCD">((</span><span style="color: #E4F0FB">resolve</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">reject</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=></span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">redisKey</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">_buildRedisKey</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">id</span><span style="color: #A6ACCD">);</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #E4F0FB">client</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">hgetall</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">redisKey</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=></span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">        </span><span style="color: #A6ACCD">if</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FBD0">reject</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">        </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FBD0">resolve</span><span style="color: #A6ACCD">({</span></span>
<span class="line"><span style="color: #E4F0FB">          </span><span style="color: #ADD7FF">key</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">redisKey</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #E4F0FB">          </span><span style="color: #ADD7FF">_id</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">id</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #E4F0FB">          </span><span style="color: #91B4D5">...</span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">_unpackHashValues</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">),</span></span>
<span class="line"><span style="color: #E4F0FB">        </span><span style="color: #A6ACCD">});</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #A6ACCD">});</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #A6ACCD">});</span></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #A6ACCD">}</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span></code></pre>
<p>Here is where we use a <code>parsify</code> method to convert our attribute strings into their original data type.</p>
<p>And that handles our finding and deserialization.</p>
<h3 id="indexing-and-sorting"><a aria-hidden="true" tabindex="-1" href="#indexing-and-sorting"><a href="#indexing-and-sorting" style="margin-right: 10px">#</a></a>Indexing and Sorting</h3>
<p>Here is the tricky part. Redis, as a key/value store doesnt have any real sense of ordering when it comes to its keys. But its important for our use case to be able to see the most recent logs, and maybe later be able to query date ranges of when the logs were created.</p>
<p>So what we're going to do is use the redis function <code>zadd</code> to add the redis key and timestamp for each object into a sorted redis list.</p>
<p>Remember from our schema, indexes look like this:</p>
<pre class="shiki poimandres" style="background-color: #1b1e28" tabindex="0"><code><span class="line"><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">getName</span><span style="color: #A6ACCD">: () </span><span style="color: #91B4D5">=></span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">createdAt</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">shouldIndex</span><span style="color: #A6ACCD">: () </span><span style="color: #91B4D5">=></span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">true</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #91B4D5">getValue</span><span style="color: #A6ACCD">: </span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=></span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">new</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FBD0">Date</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">createdAt</span><span style="color: #A6ACCD">).</span><span style="color: #E4F0FBD0">getTime</span><span style="color: #A6ACCD">(),</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span></code></pre>
<p><code>getName</code> is a function because I've found it useful to be able to create some indexes that are isolated in different ways. For example I've sometimes added indexes that are based on the ID of the user who created the log, this lets me easily get a list of all the user's most recent indexes. And in that case the <code>getName</code> looks like this <code>getName: data => ('user:'+data.user._id+':createdAt')</code>.</p>
<p><code>shouldIndex</code> lets us not index any object we want, and <code>getValue</code> gives us the actual value of the index, so this actually lets us create sorted lists using any different attribute not just createdAt. Just remember that <code>getValue</code> has to return a number.</p>
<p>Now we modify our <code>create</code> function to include a <code>zadd</code> for each index in our schema:</p>
<pre class="shiki poimandres" style="background-color: #1b1e28" tabindex="0"><code><span class="line"><span style="color: #E4F0FBD0">_buildIndexName</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">indexName</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> { </span><span style="color: #E4F0FB">schema</span><span style="color: #A6ACCD"> } </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">props</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #5DE4C7C0">return</span><span style="color: #A6ACCD"> </span><span style="color: #A6ACCD">`${</span><span style="color: #E4F0FB">schema</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">namespace</span><span style="color: #A6ACCD">}</span><span style="color: #5DE4C7">:</span><span style="color: #A6ACCD">${</span><span style="color: #E4F0FB">indexName</span><span style="color: #A6ACCD">}`</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #A6ACCD">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #E4F0FBD0">create</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> { </span><span style="color: #E4F0FB">schema</span><span style="color: #A6ACCD">, </span><span style="color: #E4F0FB">client</span><span style="color: #A6ACCD"> } </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">props</span><span style="color: #A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">    </span><span style="color: #5DE4C7C0">return</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7">new</span><span style="color: #A6ACCD"> </span><span style="color: #ADD7FF">Promise</span><span style="color: #A6ACCD">((</span><span style="color: #E4F0FB">resolve</span><span style="color: #A6ACCD">, </span><span style="color: #E4F0FB">reject</span><span style="color: #A6ACCD">) </span><span style="color: #91B4D5">=></span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">multi</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">client</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">multi</span><span style="color: #A6ACCD">();</span></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">id</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FBD0">buildId</span><span style="color: #A6ACCD">();</span></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">redisKey</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">_buildRedisKey</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">id</span><span style="color: #A6ACCD">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #767C9DB0; font-style: italic">// Handle the hash values</span></span>
<span class="line"><span style="color: #A6ACCD">      </span><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">hashValues</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">_buildHashValues</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">);</span></span>
<span class="line"><span style="color: #A6ACCD">      if (</span><span style="color: #E4F0FB">hashValues</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">        </span><span style="color: #E4F0FB">multi</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">hmset</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">redisKey</span><span style="color: #A6ACCD">, </span><span style="color: #E4F0FB">hashValues</span><span style="color: #A6ACCD">);</span></span>
<span class="line"><span style="color: #A6ACCD">        </span><span style="color: #E4F0FB">multi</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">hmset</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">redisKey</span><span style="color: #A6ACCD">, </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">EX</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">, </span><span style="color: #E4F0FBD0">expSeconds</span><span style="color: #A6ACCD">());</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">        </span><span style="color: #767C9DB0; font-style: italic">// Handle indexes</span></span>
<span class="line"><span style="color: #A6ACCD">        if (</span><span style="color: #E4F0FB">schema</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">indexes</span><span style="color: #A6ACCD">) {</span></span>
<span class="line"><span style="color: #A6ACCD">          </span><span style="color: #E4F0FB">_</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">each</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">schema</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">indexes</span><span style="color: #A6ACCD">, (</span><span style="color: #E4F0FB">index</span><span style="color: #A6ACCD">) </span><span style="color: #91B4D5">=></span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #A6ACCD">            if (</span><span style="color: #E4F0FB">index</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">shouldIndex</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">)) {</span></span>
<span class="line"><span style="color: #A6ACCD">              </span><span style="color: #E4F0FB">multi</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">zadd</span><span style="color: #A6ACCD">(</span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">_buildIndexName</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">index</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">getName</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">)), </span><span style="color: #E4F0FB">index</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">getValue</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">), </span><span style="color: #E4F0FB">redisKey</span><span style="color: #A6ACCD">);</span></span>
<span class="line"><span style="color: #A6ACCD">            }</span></span>
<span class="line"><span style="color: #A6ACCD">          });</span></span>
<span class="line"><span style="color: #A6ACCD">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">        </span><span style="color: #E4F0FB">multi</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">exec</span><span style="color: #A6ACCD">((</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">) </span><span style="color: #91B4D5">=></span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #A6ACCD">          if (</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">) </span><span style="color: #5DE4C7C0">return</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FBD0">reject</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #A6ACCD">          </span><span style="color: #5DE4C7C0">return</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FBD0">resolve</span><span style="color: #A6ACCD">({</span><span style="color: #E4F0FB"> </span><span style="color: #ADD7FF">key</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">redisKey</span><span style="color: #A6ACCD">,</span><span style="color: #E4F0FB"> </span><span style="color: #ADD7FF">_id</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">id</span><span style="color: #A6ACCD">,</span><span style="color: #E4F0FB"> </span><span style="color: #91B4D5">...</span><span style="color: #E4F0FB">data</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">});</span></span>
<span class="line"><span style="color: #A6ACCD">        });</span></span>
<span class="line"><span style="color: #A6ACCD">      } else {</span></span>
<span class="line"><span style="color: #A6ACCD">        </span><span style="color: #E4F0FBD0">reject</span><span style="color: #A6ACCD">(</span><span style="color: #5DE4C7">new</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FBD0">Error</span><span style="color: #A6ACCD">(</span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">Empty redis hash data</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">));</span></span>
<span class="line"><span style="color: #A6ACCD">      }</span></span>
<span class="line"><span style="color: #A6ACCD">    });</span></span>
<span class="line"><span style="color: #A6ACCD">  }</span></span></code></pre>
<p>This inserts the <code>redisKey</code> of each object into a sorted list based on the createdAt timestamp of the object.</p>
<p>Now we can easily retrieve the top objects from any index with a function like this:</p>
<pre class="shiki poimandres" style="background-color: #1b1e28" tabindex="0"><code><span class="line"><span style="color: #5DE4C7">export default </span><span style="color: #91B4D5">class</span><span style="color: #5DE4C7"> </span><span style="color: #ADD7FF">RedisModel</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #A6ACCD">  </span><span style="color: #767C9DB0; font-style: italic">// ...</span></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #ADD7FF">_clearOldIndexes</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">indexName</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">client</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">schema</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">}</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">props</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> new </span><span style="color: #ADD7FF">Promise</span><span style="color: #A6ACCD">((</span><span style="color: #E4F0FB">resolve</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">reject</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=></span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">now</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> new </span><span style="color: #E4F0FBD0">Date</span><span style="color: #A6ACCD">().</span><span style="color: #E4F0FBD0">getTime</span><span style="color: #A6ACCD">();</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">secondsPerDay</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> 86400</span><span style="color: #A6ACCD">;</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">args</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">[</span></span>
<span class="line"><span style="color: #5DE4C7">        </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">_buildIndexName</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">schema</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">indexName</span><span style="color: #A6ACCD">),</span></span>
<span class="line"><span style="color: #5DE4C7">        </span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">now</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">+</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FBD0">expSeconds</span><span style="color: #A6ACCD">()</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">-</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">secondsPerDay</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">*</span><span style="color: #5DE4C7"> 1000</span><span style="color: #A6ACCD">),</span></span>
<span class="line"><span style="color: #5DE4C7">        </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">-inf</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #A6ACCD">];</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #E4F0FB">client</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">zremrangebyscore</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">args</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">results</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=></span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">        </span><span style="color: #A6ACCD">if</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FBD0">reject</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">        </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FBD0">resolve</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">results</span><span style="color: #A6ACCD">);</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #A6ACCD">});</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #A6ACCD">});</span></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #A6ACCD">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #ADD7FF">_getIndexedIds</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">indexName</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">offset</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">limit</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">client</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">}</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">props</span><span style="color: #A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">_clearOldIndexes</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">indexName</span><span style="color: #A6ACCD">)</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">then</span><span style="color: #A6ACCD">(()</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=></span><span style="color: #5DE4C7"> new </span><span style="color: #ADD7FF">Promise</span><span style="color: #A6ACCD">((</span><span style="color: #E4F0FB">resolve</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">reject</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=></span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">        </span><span style="color: #91B4D5">const</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">args</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">[</span><span style="color: #E4F0FB">indexName</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">+inf</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">-inf</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">LIMIT</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">offset</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">||</span><span style="color: #5DE4C7"> 0</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">limit</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">||</span><span style="color: #5DE4C7"> 20</span><span style="color: #A6ACCD">];</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">        </span><span style="color: #E4F0FB">client</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">zrevrangebyscore</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">args</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FB">results</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=></span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">          </span><span style="color: #A6ACCD">if</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FBD0">reject</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">err</span><span style="color: #A6ACCD">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">          </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #E4F0FBD0">resolve</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">results</span><span style="color: #A6ACCD">);</span></span>
<span class="line"><span style="color: #5DE4C7">        </span><span style="color: #A6ACCD">});</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #A6ACCD">}));</span></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #A6ACCD">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #ADD7FF">fromIndex</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">indexName</span><span style="color: #A6ACCD">)</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #5DE4C7">    </span><span style="color: #5DE4C7C0">return</span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">_getIndexedIds</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">indexName</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> </span><span style="color: #D0679D">undefined</span><span style="color: #A6ACCD">,</span><span style="color: #5DE4C7"> 250</span><span style="color: #A6ACCD">)</span></span>
<span class="line"><span style="color: #5DE4C7">      </span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">then</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">results</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=></span><span style="color: #5DE4C7"> </span><span style="color: #ADD7FF">Promise</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">all</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">results</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">map</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">result</span><span style="color: #5DE4C7"> </span><span style="color: #91B4D5">=></span><span style="color: #5DE4C7"> </span><span style="color: #5DE4C7; font-style: italic">this</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">findOne</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">result</span><span style="color: #A6ACCD">))));</span></span>
<span class="line"><span style="color: #5DE4C7">  </span><span style="color: #A6ACCD">}</span></span>
<span class="line"><span style="color: #A6ACCD">}</span></span></code></pre>
<p>Notice that inside <code>_getIndexedIds</code> we first <code>_clearOldIndexes</code>. This is because redis does not allow us to set expiration times for entries inside of a list so I get around this by first removing all entries that are expired before actually getting a list of all the entries in the list.</p>
<p>Then it gets a list of all the ids using the <a href="">zrangebyscore</a> function. Then it converts each one into its full object using the <code>findOne</code> function that we already made.</p>
<h3 id="usage"><a aria-hidden="true" tabindex="-1" href="#usage"><a href="#usage" style="margin-right: 10px">#</a></a>Usage</h3>
<p>Now that we have our basic <code>RedisModel</code> class we can create new models by just exporting an instance with our schema. For example we could have a <code>models/log.js</code> file that looks like this:</p>
<pre class="shiki poimandres" style="background-color: #1b1e28" tabindex="0"><code><span class="line"><span style="color: #767C9DB0; font-style: italic">// models/log.js</span></span>
<span class="line"><span style="color: #5DE4C7">import </span><span style="color: #ADD7FF">RedisModel</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">from</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">../lib/redis</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">logSchema</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> {</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">namespace</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">logs</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">indexes</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">[</span></span>
<span class="line"><span style="color: #ADD7FF">    </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #E4F0FB">      </span><span style="color: #ADD7FF">getName</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">()</span><span style="color: #ADD7FF"> </span><span style="color: #91B4D5">=></span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">createdAt</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #E4F0FB">      </span><span style="color: #ADD7FF">shouldIndex</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">()</span><span style="color: #ADD7FF"> </span><span style="color: #91B4D5">=></span><span style="color: #ADD7FF"> </span><span style="color: #5DE4C7">true</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #E4F0FB">      </span><span style="color: #ADD7FF">addNonTenantIndex</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">()</span><span style="color: #ADD7FF"> </span><span style="color: #91B4D5">=></span><span style="color: #ADD7FF"> </span><span style="color: #5DE4C7">true</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #E4F0FB">      </span><span style="color: #ADD7FF">getValue</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FB">data</span><span style="color: #ADD7FF"> </span><span style="color: #91B4D5">=></span><span style="color: #ADD7FF"> </span><span style="color: #5DE4C7">new</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FBD0">Date</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">data</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FB">createdAt</span><span style="color: #A6ACCD">).</span><span style="color: #E4F0FBD0">getTime</span><span style="color: #A6ACCD">(),</span></span>
<span class="line"><span style="color: #E4F0FB">    </span><span style="color: #A6ACCD">},</span></span>
<span class="line"><span style="color: #ADD7FF">  </span><span style="color: #A6ACCD">],</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">attributes</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">{</span></span>
<span class="line"><span style="color: #E4F0FB">    </span><span style="color: #ADD7FF">source</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">{</span><span style="color: #E4F0FB"> </span><span style="color: #ADD7FF">kind</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">string</span><span style="color: #A6ACCD">'</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">},</span></span>
<span class="line"><span style="color: #E4F0FB">    </span><span style="color: #ADD7FF">user</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">{</span><span style="color: #E4F0FB"> </span><span style="color: #ADD7FF">kind</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">object</span><span style="color: #A6ACCD">'</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">},</span></span>
<span class="line"><span style="color: #E4F0FB">    </span><span style="color: #ADD7FF">body</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">{</span><span style="color: #E4F0FB"> </span><span style="color: #ADD7FF">kind</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">object</span><span style="color: #A6ACCD">'</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">},</span></span>
<span class="line"><span style="color: #E4F0FB">    </span><span style="color: #ADD7FF">createdAt</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">{</span><span style="color: #E4F0FB"> </span><span style="color: #ADD7FF">kind</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">time</span><span style="color: #A6ACCD">'</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">},</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #A6ACCD">},</span></span>
<span class="line"><span style="color: #A6ACCD">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #5DE4C7">export default new </span><span style="color: #E4F0FBD0">RedisModel</span><span style="color: #A6ACCD">(</span><span style="color: #E4F0FB">schema</span><span style="color: #A6ACCD">);</span></span></code></pre>
<p>Then in other parts of our program we can do things like this:</p>
<pre class="shiki poimandres" style="background-color: #1b1e28" tabindex="0"><code><span class="line"><span style="color: #5DE4C7">import </span><span style="color: #ADD7FF">Log</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">from</span><span style="color: #5DE4C7"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">../models/log</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #767C9DB0; font-style: italic">// Get a list of logs</span></span>
<span class="line"><span style="color: #91B4D5">const</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">logList</span><span style="color: #A6ACCD"> </span><span style="color: #91B4D5">=</span><span style="color: #A6ACCD"> </span><span style="color: #E4F0FB">Log</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">fromIndex</span><span style="color: #A6ACCD">(</span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">createdAt</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #767C9DB0; font-style: italic">// Find a specific log</span></span>
<span class="line"><span style="color: #E4F0FB">Log</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">findOne</span><span style="color: #A6ACCD">(</span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">123456</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #767C9DB0; font-style: italic">// Create a new log</span></span>
<span class="line"><span style="color: #E4F0FB">Log</span><span style="color: #A6ACCD">.</span><span style="color: #E4F0FBD0">create</span><span style="color: #A6ACCD">({</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">source</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">Web</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">body</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">An error happened</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">,</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">user</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">{</span><span style="color: #E4F0FB"> </span><span style="color: #ADD7FF">email</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #A6ACCD">'</span><span style="color: #5DE4C7">joe@cool.com</span><span style="color: #A6ACCD">'</span><span style="color: #A6ACCD">,</span><span style="color: #E4F0FB">  </span><span style="color: #A6ACCD">},</span></span>
<span class="line"><span style="color: #E4F0FB">  </span><span style="color: #ADD7FF">createdAt</span><span style="color: #A6ACCD">:</span><span style="color: #ADD7FF"> </span><span style="color: #5DE4C7">new</span><span style="color: #ADD7FF"> </span><span style="color: #E4F0FBD0">Date</span><span style="color: #A6ACCD">(),</span></span>
<span class="line"><span style="color: #A6ACCD">});</span></span></code></pre>
<p>And based on how we built it, we think about our individual objects in terms of <code>ids</code> and not keys.</p>
<h3 id="conclusion"><a aria-hidden="true" tabindex="-1" href="#conclusion"><a href="#conclusion" style="margin-right: 10px">#</a></a>Conclusion</h3>
<p>You can see a <a href="https://gist.github.com/nmajor/e772d0dd166c8c3bbffb2bee00faa8a2" title="https://gist.github.com/nmajor/e772d0dd166c8c3bbffb2bee00faa8a2">gist with the full RedisModel class here</a>. Keep in mind this is mostly just to give a possible starting point. Its possible there are some bugs in here since I had to water down my implementation a bit to keep this post concise.</p>
<p>As always, please let me know if you see any issues with the code, or possible problems with my implementation or design choices. I'm always learning.</p>
<p>Thanks for reading!</p>a:["$","div",null,{"className":"sm:px-8 post mt-16 lg:mt-32","children":["$","div",null,{"className":"mx-auto w-full max-w-7xl lg:px-8","children":["$","div",null,{"className":"relative px-4 sm:px-8 lg:px-12","children":["$","div",null,{"className":"mx-auto max-w-2xl lg:max-w-5xl","children":["$","div",null,{"className":"xl:relative","children":["$","div",null,{"className":"mx-auto max-w-2xl","children":["$","article",null,{"children":[["$","header",null,{"className":"flex flex-col","children":[["$","h1",null,{"className":"text-4xl font-bold font-bold tracking-tight sm:text-5xl","children":"Simple Object Storage in Redis (Node.js)"}],["$","div",null,{"className":"flex gap-3 pt-1","children":[["$","time",null,{"dateTime":"2018-10-05","className":"text-muted-foreground order-first flex items-center pr-2 text-base","children":[["$","span",null,{"className":"h-4 w-0.5 rounded-full bg-zinc-200 dark:bg-zinc-500"}],["$","span",null,{"className":"ml-3","children":"October 5, 2018"}]]}],["$","span",null,{"className":"text-muted-foreground","children":"-"}],[["$","span","node",{"className":"text-muted-foreground/80","children":"node"}],["$","span","redis",{"className":"text-muted-foreground/80","children":"redis"}],["$","span","javascript",{"className":"text-muted-foreground/80","children":"javascript"}]]]}],["$","div",null,{"className":"text-accent-foreground pt-3 text-sm italic","children":["~","10 min read"]}]]}],["$","div",null,{"className":"mt-8 prose dark:prose-invert","data-mdx-content":true,"children":["$","div",null,{"dangerouslySetInnerHTML":{"__html":"$b"}}]}]]}]}]}]}]}]}]}]
3:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","meta","1",{"charSet":"utf-8"}],["$","title","2",{"children":"Simple Object Storage in Redis (Node.js) - Spencer Sharp"}],["$","meta","3",{"name":"description","content":"I’m Spencer, a software designer and entrepreneur based in New York City. I’m the founder and CEO of Planetaria, where we develop technologies that empower regular people to explore space on their own terms."}],["$","link","4",{"rel":"alternate","type":"application/rss+xml","href":"undefined/feed.xml"}]]
9:null
